<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tarot Â· çº¯æ–‡å­—æŠ½ç‰Œï¼ˆv2.1 Flow & Memoryï¼‰</title>
<style>
  :root{
    /* dark base */
    --bg:#0c0f13; --panel:#151922; --text:#e8ecf2; --muted:#9aa3b2; --line:#242a34;
    --input-bg:#1b2029; --input-border:#2a3140; --placeholder:#7b8494;
    /* brand default = blue */
    --brand:#6aa2ff; --brand-ink:#0b1324;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f8fa; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
           --input-bg:#f1f3f5; --input-border:#d1d5db; --placeholder:#9ca3af; --brand:#4a6cf7; --brand-ink:#ffffff; }
  }
  body.light{ --bg:#f7f8fa; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
              --input-bg:#f1f3f5; --input-border:#d1d5db; --placeholder:#9ca3af; }
  body.brand-blue{ --brand:#6aa2ff; --brand-ink:#0b1324; }
  body.brand-purple{ --brand:#b993ff; --brand-ink:#120a1a; }
  body.brand-gold{ --brand:#f1c232; --brand-ink:#201a06; }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1000px;margin:36px auto;padding:0 16px}
  .h1{font-size:22px;font-weight:700;display:flex;align-items:center;gap:10px}
  .muted{color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  @media(max-width:820px){.row,.row-3{grid-template-columns:1fr}}
  label{display:block;font-weight:600;margin-bottom:6px}

  input[type="text"],select,textarea{width:100%;background:var(--input-bg);color:var(--text);
    border:1px solid var(--input-border);border-radius:12px;padding:10px 12px;outline:none}
  input::placeholder,textarea::placeholder{color:var(--placeholder)}

  .btns{display:flex;gap:10px;flex-wrap:wrap}
  button{background:var(--input-bg);color:var(--text);border:1px solid var(--input-border);
    padding:10px 14px;border-radius:12px;cursor:pointer;transition:filter .12s ease, box-shadow .12s ease}
  button:hover{ filter:brightness(1.05) }
  button.primary{border-color:#2b3340}
  button.accent{background:var(--brand);border-color:var(--brand);color:var(--brand-ink)}
  button.accent:hover{ box-shadow:0 0 0 3px color-mix(in srgb, var(--brand) 35%, transparent) inset }
  button:active{transform:translateY(1px)}

  .hr{height:1px;background:var(--line);margin:14px 0}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{border:1px dashed var(--input-border);border-radius:12px;padding:10px 12px}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--brand);color:var(--brand-ink);font-size:12px;transition:filter .12s ease}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--input-border);border-radius:999px;font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--input-bg);border:1px solid var(--input-border);padding:0 6px;border-radius:6px}
  .right{margin-left:auto}
</style>
</head>
<body class="brand-blue">
<div class="wrap">
  <div class="h1">
    <span>Tarot Â· çº¯æ–‡å­—æŠ½ç‰Œï¼ˆv2.1ï¼‰</span>
    <span class="pill">å•æ–‡ä»¶ / æœ¬åœ°å¯å¼€</span>
    <span class="right"></span>
    <select id="brandPick" title="ä¸»é¢˜ä¸»è‰²" style="max-width:160px">
      <option value="blue">ä¸»é¢˜è‰²ï¼šè“ï¼ˆç†æ€§ï¼‰</option>
      <option value="purple">ä¸»é¢˜è‰²ï¼šç´«ï¼ˆç›´è§‰ï¼‰</option>
      <option value="gold">ä¸»é¢˜è‰²ï¼šé‡‘ï¼ˆåŠ›é‡ï¼‰</option>
    </select>
    <button id="themeToggle" type="button">ğŸŒ™/â˜€ï¸ ä¸»é¢˜</button>
  </div>
  <div class="muted" style="margin-top:6px">ä¸é‡å¤æŠ½ç‰Œã€æ°¸è¿œå¯é€†ä½ï¼›æŠ½ç‰Œå…ˆä»…æ˜¾ç¤ºç‰Œé¢ä¸æ­£/é€†ï¼Œç‚¹å‡»åæ˜¾ç¤ºä¸­æ€§é‡Šä¹‰ï¼›å…³é”®è¯å•ç‹¬å¼€å…³ã€‚</div>

  <div class="hr"></div>

  <section class="card">
    <div class="row-3">
      <div>
        <label>æ¨¡å¼</label>
        <select id="mode">
          <option value="single">å•å¼ </option>
          <option value="ppf">ä¸‰å¼ ï¼ˆè¿‡å»-ç°åœ¨-æœªæ¥ï¼‰</option>
          <option value="relationship">å…³ç³»ç›˜ï¼ˆä½ /å¯¹æ–¹/æ ¸å¿ƒ/é˜»ç¢/å»ºè®®ï¼‰</option>
          <option value="five">äº”å¼ ï¼ˆç°çŠ¶/é˜»ç¢/æ ¹æº/æ½œåŠ›/å»ºè®®ï¼‰</option>
          <option value="six">å…­èŠ’æ˜Ÿï¼ˆç°çŠ¶/é˜»ç¢/åŠ©åŠ›/è¡ŒåŠ¨/å¤–ç•Œ/ç»“æœï¼‰</option>
          <option value="seven">ä¸ƒå¼ ï¼ˆä¸»é¢˜/éšœç¢/æ ¹æº/è¿‡å»/ç°åœ¨/æœªæ¥/å»ºè®®ï¼‰</option>
          <option value="ten">åå¼ ï¼ˆå‡¯å°”ç‰¹åå­—ï¼‰</option>
        </select>
      </div>
      <div>
        <label>å åœåˆ†ç±»</label>
        <select id="category">
          <option>æƒ…æ„Ÿ</option><option>äº‹ä¸š</option><option>å­¦ä¸š</option>
          <option>å¥åº·</option><option>è´¢åŠ¡</option><option>äººé™…</option><option>å…¶ä»–</option>
        </select>
      </div>
      <div>
        <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
        <input id="note" type="text" placeholder="ä¸ºè¿™æ¬¡å åœå†™ä¸€å¥è¯â€¦">
      </div>
    </div>
    <div class="btns" style="margin-top:14px">
      <button class="accent" id="draw" type="button">æŠ½ ç‰Œ</button>
      <button class="primary" id="redraw" type="button">é‡æ–°æŠ½å–</button>
      <button id="reset" type="button">æ¸…ç©ºç»“æœ</button>
    </div>
  </section>

  <div style="height:14px"></div>

  <section class="card" id="result">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div style="font-weight:700">æŠ½ç‰Œç»“æœ</div>
      <div class="btns">
        <button id="toggleExplain" type="button">æŸ¥çœ‹è§£è¯»ï¼ˆä¸­æ€§ï¼‰</button>
        <button id="toggleKW" type="button">æ˜¾ç¤ºå…³é”®è¯</button>
        <button id="copyMd" type="button">å¤åˆ¶ Markdown</button>
        <button id="exportReport" type="button">å¯¼å‡ºæŠ¥å‘Šï¼ˆMDï¼‰</button>
        <button id="exportCSV" type="button">å¯¼å‡º CSV</button>
        <button id="exportJSON" type="button">å¯¼å‡º JSON</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="cards" class="list"></div>
  </section>

  <div style="height:14px"></div>

  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div style="font-weight:700">å†å²è®°å½•ï¼ˆåˆ†é¡µ / æ¯é¡µ 5 æ¡ï¼‰</div>
      <div class="btns">
        <input id="filterKw" type="text" placeholder="æŒ‰å…³é”®è¯/å¤‡æ³¨è¿‡æ»¤â€¦" style="min-width:200px">
        <select id="filterCat">
          <option value="">å…¨éƒ¨åˆ†ç±»</option>
          <option>æƒ…æ„Ÿ</option><option>äº‹ä¸š</option><option>å­¦ä¸š</option>
          <option>å¥åº·</option><option>è´¢åŠ¡</option><option>äººé™…</option><option>å…¶ä»–</option>
        </select>
        <button id="clearHistory" type="button">æ¸…ç©ºå†å²</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="historyList" class="list"></div>
    <div class="btns" style="justify-content:flex-end">
      <button id="prevPage" type="button">ä¸Šä¸€é¡µ</button>
      <span class="pill" id="pageInfo">1 / 1</span>
      <button id="nextPage" type="button">ä¸‹ä¸€é¡µ</button>
    </div>
  </section>

  <div style="height:18px"></div>
  <div class="muted">æç¤ºï¼šä¸»é¢˜è‰²ï¼ˆè“/ç´«/é‡‘ï¼‰ä¼šåŒæ—¶ä½œç”¨äºæ˜/æš—æ¨¡å¼ï¼›è‹¥æœªç”Ÿæ•ˆè¯·å¼ºåˆ· <span class="kbd">Ctrl/Cmd+Shift+R</span>ã€‚</div>
</div>

<script>
(function(){
  // ---- æ•°æ® ----
  var MAJOR=[
    {id:0,name:"The Fool",cn:"æ„šè€…",upr:["æ–°å¼€å§‹","è‡ªç”±","å†’é™©"],rev:["é²è½","çŠ¹è±«","æ–¹å‘ä¸æ˜"]},
    {id:1,name:"The Magician",cn:"é­”æœ¯å¸ˆ",upr:["æ„å¿—","èµ„æºæ•´åˆ","æ˜¾åŒ–"],rev:["æ“å¼„","åˆ†æ•£","æŠ€å·§å¤±çµ"]},
    {id:2,name:"The High Priestess",cn:"å¥³ç¥­å¸",upr:["ç›´è§‰","æ½œæ„è¯†","ä¿ç•™"],rev:["ç§˜å¯†","å‹æŠ‘","è‡ªæ¬º"]},
    {id:3,name:"The Empress",cn:"å¥³çš‡",upr:["ä¸°é¥¶","æ»‹å…»","å…³ç³»æˆé•¿"],rev:["è¿‡åº¦æººçˆ±","åœæ»","ä¾èµ–"]},
    {id:4,name:"The Emperor",cn:"çš‡å¸",upr:["ç»“æ„","æƒå¨","ç§©åº"],rev:["åƒµåŒ–","ç‹¬æ–­","æ§åˆ¶"]},
    {id:5,name:"The Hierophant",cn:"æ•™çš‡",upr:["ä¼ ç»Ÿ","å­¦ä¹ ","è§„èŒƒ"],rev:["æ•™æ¡","å›é€†","å½¢å¼ä¸»ä¹‰"]},
    {id:6,name:"The Lovers",cn:"æ‹äºº",upr:["é€‰æ‹©","å…³ç³»å¥‘åˆ","ä»·å€¼ä¸€è‡´"],rev:["æ‘‡æ‘†","è¯±æƒ‘","ä¸ä¸€è‡´"]},
    {id:7,name:"The Chariot",cn:"æˆ˜è½¦",upr:["æŒæ§","æ¨è¿›","èƒœåˆ©"],rev:["å¤±æ§","åˆ†è£‚","åŠ¨åŠ›ä¸è¶³"]},
    {id:8,name:"Strength",cn:"åŠ›é‡",upr:["è€å¿ƒ","æ¸©æŸ”çš„åŠ›é‡","è‡ªå¾‹"],rev:["æ€¥èº","å‹æŠ‘","è‡ªæˆ‘æ€€ç–‘"]},
    {id:9,name:"The Hermit",cn:"éšå£«",upr:["ç‹¬å¤„","å†…çœ","æŒ‡å¯¼"],rev:["é—­å¡","å­¤ç«‹","é€ƒé¿"]},
    {id:10,name:"Wheel of Fortune",cn:"å‘½è¿ä¹‹è½®",upr:["è½¬æœº","å‘¨æœŸ","æœºç¼˜"],rev:["é”™ä½","åœæ»","æ—¶æœºæœªè‡³"]},
    {id:11,name:"Justice",cn:"æ­£ä¹‰",upr:["å…¬å¹³","å› æœ","å†³æ–­"],rev:["åé¢‡","ä¸å¯¹ç­‰","æ‹–å»¶è£å†³"]},
    {id:12,name:"The Hanged Man",cn:"å€’åŠäºº",upr:["è§†è§’è½¬æ¢","æš‚åœ","ç‰ºç‰²"],rev:["å†…è€—","åƒµæŒ","ä¸æ„¿æ”¾ä¸‹"]},
    {id:13,name:"Death",cn:"æ­»ç¥",upr:["ç»ˆç»“ä¸é‡ç”Ÿ","æ–­èˆç¦»","æ›´æ–°"],rev:["æŠ—æ‹’æ”¹å˜","æ‹–å»¶","æ—§é—®é¢˜åå¤"]},
    {id:14,name:"Temperance",cn:"èŠ‚åˆ¶",upr:["è°ƒå’Œ","èŠ‚å¾‹","ä¸­é“"],rev:["å¤±è¡¡","è¿‡åº¦","èŠ‚å¥æ··ä¹±"]},
    {id:15,name:"The Devil",cn:"æ¶é­”",upr:["æ¬²æœ›","æŸç¼š","å¥‘çº¦"],rev:["è§‰é†’","è§£è„±","æ–­é“¾"]},
    {id:16,name:"The Tower",cn:"é«˜å¡”",upr:["çªå˜","å´©å¡Œ","çœŸç›¸æ˜¾éœ²"],rev:["å»¶è¿Ÿçˆ†å‘","ä½™éœ‡","ä¾¥å¹¸æœªå†³"]},
    {id:17,name:"The Star",cn:"æ˜Ÿæ˜Ÿ",upr:["å¸Œæœ›","ç–—æ„ˆ","è¿œæ™¯"],rev:["å¤±æœ›","æ¶ˆè€—","å…‰èŠ’å¾®å¼±"]},
    {id:18,name:"The Moon",cn:"æœˆäº®",upr:["è¿·é›¾","æƒ³è±¡","æ½œä¼"],rev:["æ˜æœ—","æ¸…é†’","ç–‘è™‘æ•£å»"]},
    {id:19,name:"The Sun",cn:"å¤ªé˜³",upr:["æ¸…æ™°","æˆåŠŸ","ç«¥çœŸ"],rev:["è¿‡æ›","è‡ªæ»¡","çŸ­æš‚å—é˜»"]},
    {id:20,name:"Judgement",cn:"å®¡åˆ¤",upr:["å¬å›","è§‰é†’","å¤ç›˜"],rev:["è¿Ÿç–‘","è‡ªè´£","é”™å¤±å¬å”¤"]},
    {id:21,name:"The World",cn:"ä¸–ç•Œ",upr:["å®Œæˆ","æ•´åˆ","æ—…ç¨‹ç»ˆç‚¹"],rev:["æœªç«Ÿä¹‹äº‹","æ”¶å°¾å›°éš¾","è¾¹ç•Œä¸æ¸…"]}
  ];
  var MEANING={
    0:{upr:"æ–°çš„å¼€ç«¯ä¸æ¢ç´¢çš„çŠ¶æ€ï¼Œé‡è§†ç›´è§‰ä¸ä½“éªŒï¼›å¼ºè°ƒå¼€æ”¾å¿ƒæ€ä¸æœªçŸ¥æ„Ÿã€‚",rev:"èƒ½é‡åˆ†æ•£æˆ–å‡†å¤‡ä¸è¶³çš„çŠ¶æ€ï¼Œå¯¹æ–¹å‘ä¸è¾¹ç•Œçš„æŠŠæ¡è¾ƒå¼±ã€‚"},
    1:{upr:"æ„å¿—ä¸èµ„æºè¢«è°ƒåŠ¨ä»¥è¾¾æˆç›®æ ‡çš„é˜¶æ®µï¼Œé‡åœ¨å¯è¡Œã€‚",rev:"å·¥å…·æˆ–æ²Ÿé€šçš„å¤±çµï¼ŒåŠ›é‡æœªèšæ‹¢ï¼Œæ•ˆæœä¸æ˜¾ã€‚"},
    2:{upr:"ä¿¡æ¯å°šåœ¨æ½œä¼æœŸï¼Œé€‚åˆè§‚å¯Ÿã€ä¿ç•™æ„è§ã€ç­‰å¾…çº¿ç´¢å‡ºç°ã€‚",rev:"éšç§˜ä¸ä¸ç¡®å®šå¢å¤šï¼Œéš¾ä»¥ç›´æ¥è·å–æ˜ç¡®è®¯æ¯ã€‚"},
    3:{upr:"æ»‹å…»ä¸ç”Ÿé•¿çš„ç¯å¢ƒï¼Œå¼ºè°ƒå…³ç³»/é¡¹ç›®çš„åŸ¹è‚²ä¸æ‰©å±•ã€‚",rev:"æŠ•å…¥ä¸äº§å‡ºä¸å‡è¡¡ï¼Œæˆ–è¿‡åº¦ä¾èµ–å¸¦æ¥çš„åœæ»ã€‚"},
    4:{upr:"ç»“æ„ã€ç§©åºä¸è¾¹ç•Œæ¸…æ™°ï¼Œé‡è§†åˆ¶åº¦ä¸è§„åˆ™ã€‚",rev:"ç»“æ„åƒµç¡¬æˆ–æ§åˆ¶è¿‡å¼ºï¼Œå¼¹æ€§ä¸è¶³ã€‚"},
    5:{upr:"éµå¾ªæ—¢æœ‰è§„èŒƒ/ä¼ ç»Ÿçš„æ—¶æœŸï¼Œå¼ºè°ƒå­¦ä¹ ä¸ä¼ æ‰¿ã€‚",rev:"å½¢å¼æ„Ÿå‹è¿‡å®è´¨ï¼Œæˆ–å¯¹è§„åˆ™äº§ç”ŸæŠ—æ‹’ã€‚"},
    6:{upr:"ä»·å€¼å¯¹é½ä¸è¿æ¥è¯¾é¢˜è¢«æå‡ºï¼Œé¢å‘é€‰æ‹©ã€‚",rev:"æ‘‡æ‘†æˆ–è¯±å› å¢å¤šï¼Œéœ€è¦æ¾„æ¸…ç«‹åœºä¸ä»·å€¼ã€‚"},
    7:{upr:"å‘ç›®æ ‡é›†ä¸­å¹¶æ¨è¿›çš„é˜¶æ®µï¼Œæµ‹è¯•åè°ƒä¸æ„å¿—ã€‚",rev:"åŠ¨èƒ½å—é˜»æˆ–æ–¹å‘åˆ†è£‚ï¼Œæ¨è¿›æ•ˆç‡ä¸‹é™ã€‚"},
    8:{upr:"å†…åœ¨ç¨³ä½å¤–åœ¨ï¼Œå¼ºè°ƒè€å¿ƒã€è‡ªå¾‹ä¸æ¸©å’Œçš„åŠ›é‡ã€‚",rev:"è‡ªæˆ‘æ€€ç–‘æˆ–å‹æŠ‘æƒ…ç»ªï¼Œèƒ½é‡éœ€è¦å¤ä½ã€‚"},
    9:{upr:"ä¸»åŠ¨æŠ½ç¦»ä»¥è§‚å¯Ÿä¸æ€è€ƒï¼Œç§¯ç´¯æ´è§ã€‚",rev:"é—­å¡æˆ–å›é¿å¤–ç•Œäº’åŠ¨ï¼Œä¿¡æ¯æ¥æºå˜çª„ã€‚"},
    10:{upr:"å‘¨æœŸè½¬æŠ˜ç‚¹ï¼Œæœºä¼šä¸å˜åŠ¨å¹¶å­˜ã€‚",rev:"æ—¶æœºæš‚ä¸åŒ¹é…æˆ–å¤–åœ¨æ¡ä»¶æœªå°±ç»ªã€‚"},
    11:{upr:"è¯„ä¼°ä¸å¹³è¡¡çš„é˜¶æ®µï¼Œå…³æ³¨å› æœä¸å¯¹ç­‰ã€‚",rev:"å¤±è¡¡æˆ–å»¶è¿Ÿå®šå¤ºï¼Œæ ‡å‡†æ¨¡ç³Šã€‚"},
    12:{upr:"æš‚åœä»¥æ¢è§†è§’çš„é˜¶æ®µï¼Œå¼ºè°ƒè®©æ¸¡ä¸è§‚å¯Ÿã€‚",rev:"åœæ»æ„Ÿä¸Šå‡ï¼Œéš¾ä»¥æ”¾ä¸‹æ—¢æœ‰ç«‹åœºã€‚"},
    13:{upr:"é˜¶æ®µæ€§æ”¶æŸä¸æ›´æ–°çš„äº¤ç•Œï¼Œé‡Šæ”¾æ—§è¦ç´ ã€‚",rev:"å¯¹æ”¹å˜æœ‰æ‰€æŠ—æ‹’ï¼Œæ—§è®®é¢˜åå¤å‡ºç°ã€‚"},
    14:{upr:"è°ƒé…èŠ‚å¾‹ã€å¯»æ‰¾ä¸­é“ä¸ç¨³å®šè¾“å‡ºã€‚",rev:"èŠ‚å¥å¤±è¡¡ï¼Œè¿‡åº¦æˆ–ä¸è¶³å½±å“ç¨³å®šæ€§ã€‚"},
    15:{upr:"å¥‘çº¦ã€æ¬²æœ›ä¸æŸç¼šè¯¾é¢˜è¢«çœ‹è§ã€‚",rev:"ä»æŸç¼šä¸­æŠ½ç¦»çš„è¿¹è±¡ï¼Œå…³æ³¨è§£è„±è¿‡ç¨‹ã€‚"},
    16:{upr:"ç»“æ„è¢«è§¦å‘è°ƒæ•´ï¼ŒçœŸç›¸æµ®å‡ºã€‚",rev:"å˜åŒ–ä»åœ¨ç´¯ç§¯ï¼Œåç»­å½±å“å¾…è§‚å¯Ÿã€‚"},
    17:{upr:"ä¿®å¤æœŸä¸è¿œæ™¯æ„è¯†å¢å¼ºï¼Œå…³æ³¨æ¢å¤ä¸æ–¹å‘æ„Ÿã€‚",rev:"èƒ½é‡åä½æˆ–æœŸå¾…å‡å¼±ï¼Œéœ€è¦è¡¥ç»™ã€‚"},
    18:{upr:"æ¨¡ç³ŠæœŸï¼Œç›´è§‰ä¸æƒ³è±¡é«˜æ´»è·ƒï¼Œä¿¡æ¯éœ€è¾¨è¯†ã€‚",rev:"é›¾æ•£è¿¹è±¡ï¼Œåˆ¤æ–­é€æ­¥å›åˆ°æ¸…æ™°ã€‚"},
    19:{upr:"æ¸…æ™°åº¦ä¸æ˜¾åŒ–åº¦ä¸Šå‡ï¼Œç»“æœå¯è§ã€‚",rev:"å…‰ç…§è¿‡å¼ºæˆ–é˜¶æ®µæ€§å—é˜»ï¼ŒèŠ‚å¥éœ€è°ƒã€‚"},
    20:{upr:"å›çœ‹ä¸å›åº”çš„èŠ‚ç‚¹ï¼Œå¼ºè°ƒå¬å›ä¸æ•´åˆã€‚",rev:"çŠ¹è±«æˆ–è‡ªè´£å¹²æ‰°å›åº”ï¼Œçª—å£å˜çª„ã€‚"},
    21:{upr:"é˜¶æ®µæ”¶æ‹¢ã€è¦ç´ æ•´åˆï¼Œå®Œæˆåº¦æå‡ã€‚",rev:"æ”¶å°¾ä¸å®Œå…¨æˆ–è¾¹ç•Œæ¨¡ç³Šï¼Œå°šéœ€æ•´ç†ã€‚"}
  };
  var TAGS={
    single:["æ­¤åˆ»"],
    ppf:["è¿‡å»","ç°åœ¨","æœªæ¥"],
    relationship:["ä½ ","å¯¹æ–¹","å…³ç³»æ ¸å¿ƒ","é˜»ç¢","å»ºè®®"],
    five:["ç°çŠ¶","é˜»ç¢","æ ¹æº","æ½œåŠ›","å»ºè®®"],
    six:["ç°çŠ¶","é˜»ç¢","åŠ©åŠ›","è¡ŒåŠ¨","å¤–ç•Œ","ç»“æœ"],
    seven:["ä¸»é¢˜","éšœç¢","æ ¹æº","è¿‡å»","ç°åœ¨","æœªæ¥","å»ºè®®"],
    ten:["å½“ä¸‹","æŒ‘æˆ˜","æ½œæ„è¯†/æ ¹éƒ¨","æ˜¾æ„è¯†/è¡¨å±‚","è¿‡å»å½±å“","è¿‘æœŸæœªæ¥","æˆ‘æ–¹æ€åº¦","å¤–éƒ¨ç¯å¢ƒ","å¸Œæœ›/ææƒ§","ç»“æœ"]
  };

  function q(id){return document.getElementById(id);}
  function ts(){return new Date().toISOString().replace("T"," ").slice(0,19);}
  function sampleNoRepeat(arr,n){ if(n>arr.length) throw new Error("æ•°é‡è¶…è¿‡ç‰Œç»„"); var pool=arr.slice(),out=[]; for(var i=0;i<n;i++){ var idx=Math.floor(Math.random()*pool.length); out.push(pool[idx]); pool.splice(idx,1);} return out; }
  function positionTags(mode){ return TAGS[mode]||TAGS.single; }

  var SHOW_EXPLAIN=false, SHOW_KW=false, lastPack=null;

  function draw(mode){
    var n=positionTags(mode).length;
    var cards=sampleNoRepeat(MAJOR,n).map(function(c){ return {id:c.id,name:c.name,cn:c.cn,upr:c.upr,rev:c.rev,reversed:Math.random()<0.5}; });
    return {mode:mode,allowRev:true,cards:cards};
  }

  function neutralLine(card){
    var pos=card.reversed?"rev":"upr";
    var m=MEANING[card.id] ? MEANING[card.id][pos] : "";
    return "â†’ ç‰Œé¢é‡Šä¹‰ï¼š" + (m||"çŠ¶æ€æè¿°ç¼ºçœ");
  }
  function kwLine(card){
    var arr=card.reversed?card.rev:card.upr;
    var s=(arr||[]).slice(0,3).join("ã€");
    return s?("å…³é”®è¯ï¼š" + s):"";
  }

  function renderResult(pack){
    var tags=positionTags(pack.mode);
    var wrap=q("cards"); wrap.innerHTML="";
    for(var i=0;i<pack.cards.length;i++){
      var c=pack.cards[i];
      var pos=c.reversed?"é€†ä½":"æ­£ä½";
      var head='<div><span class="tag">'+tags[i]+'</span> ã€'+c.cn+' ('+c.name+')ï½œ'+pos+'ã€‘</div>';
      var body="";
      if(SHOW_EXPLAIN){ body+='<div style="margin-top:6px">'+neutralLine(c)+'</div>'; }
      if(SHOW_KW){ var k=kwLine(c); if(k){ body+='<div class="muted" style="margin-top:6px">'+k+'</div>'; } }
      var div=document.createElement("div"); div.className="item"; div.innerHTML=head+body; wrap.appendChild(div);
    }
  }

  // history (pagination + filter)
  var HKEY="tarot_history_clean_v1", PAGE=5, CUR=1;
  function loadHist(){ try{return JSON.parse(localStorage.getItem(HKEY)||"[]");}catch(e){return [];} }
  function saveHist(list){ localStorage.setItem(HKEY, JSON.stringify(list)); }
  function pushHist(item){ var l=loadHist(); l.unshift(item); saveHist(l); CUR=1; renderHistory(); }
  function applyFilter(list){
    var kw=(q("filterKw").value||"").trim();
    var cat=(q("filterCat").value||"").trim();
    return list.filter(function(r){
      var okc=!cat||r.category===cat;
      var blob=[r.mode,r.category,r.note].concat((r.cards||[]).map(function(c){return c.cn;})).join(" ");
      var okk=!kw||blob.indexOf(kw)>=0;
      return okc && okk;
    });
  }
  function renderHistory(){
    var full=loadHist(), filtered=applyFilter(full), total=filtered.length;
    var pages=Math.max(1, Math.ceil(total/PAGE));
    CUR=Math.max(1, Math.min(CUR,pages));
    var start=(CUR-1)*PAGE, slice=filtered.slice(start,start+PAGE);

    var box=q("historyList"); box.innerHTML="";
    if(!slice.length){ box.innerHTML='<div class="muted" style="text-align:center;opacity:.8">æš‚æ— è®°å½•ã€‚</div>'; }
    for(var i=0;i<slice.length;i++){
      var rec=slice[i], tags=positionTags(rec.mode);
      var lines=rec.cards.map(function(c,idx){ return tags[idx]+"ï½œ"+c.cn+(c.reversed?"(é€†)":""); }).join(" | ");
      var html='<div><span class="pill">'+rec.timestamp+'</span> <span class="pill">'+rec.mode+'</span> <span class="pill">'+(rec.category||"")+'</span> <span class="muted">'+(rec.note?("ï½œğŸ—’ï¸ "+rec.note):" ")+'</span></div><div style="margin-top:6px">'+lines+'</div>';
      var d=document.createElement("div"); d.className="item"; d.innerHTML=html; box.appendChild(d);
    }
    q("pageInfo").textContent=(pages?CUR:0)+" / "+pages;
  }

  function toMD(rec){
    var tags=positionTags(rec.mode);
    var head="### æŠ½ç‰Œç»“æœï¼ˆ"+rec.timestamp+"ï¼‰\\n- æ¨¡å¼ï¼š"+rec.mode+"ï½œåˆ†ç±»ï¼š"+rec.category+"\\n- å¤‡æ³¨ï¼š"+(rec.note||"ï¼ˆæ— ï¼‰");
    var lines=rec.cards.map(function(c,i){
      var core="- "+tags[i]+"ï½œ"+c.cn+(c.reversed?"ï¼ˆé€†ä½ï¼‰":"");
      var neu="  "+neutralLine(c);
      var kw=SHOW_KW?("  - "+kwLine(c)):"";
      return core+"\\n"+neu+(kw?("\\n"+kw):"");
    });
    return head+"\\n"+lines.join("\\n");
  }
  function download(name,text,mime){
    var a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([text],{type:mime||"text/markdown;charset=utf-8"}));
    a.download=name; a.click(); URL.revokeObjectURL(a.href);
  }

  // æ¸…ç©ºå†å²ï¼ˆä¿®å¤ï¼šç¡®è®¤ + ç«‹åˆ»é‡ç»˜ + å‹å¥½æç¤ºï¼‰
  function clearAllHistory(){
    if (!confirm("ç¡®è®¤æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;
    localStorage.removeItem(HKEY);
    renderHistory();
    var box = q("historyList"); if (box) box.innerHTML = '<div class="muted" style="text-align:center;opacity:.8">ğŸ—‘ï¸ å†å²è®°å½•å·²æ¸…ç©º</div>';
    var info = q("pageInfo"); if (info) info.textContent = '0 / 1';
  }

  // ä¸»é¢˜ä¸ä¸»è‰²
  function applyBrandClass(val){
    document.body.classList.remove("brand-blue","brand-purple","brand-gold");
    document.body.classList.add("brand-"+val);
    localStorage.setItem("tarot_brand",val);
  }
  function loadBrand(){
    var v=localStorage.getItem("tarot_brand")||"blue";
    q("brandPick").value=v; applyBrandClass(v);
  }
  function toggleTheme(){
    var light=document.body.classList.toggle("light");
    localStorage.setItem("tarot_theme", light?"light":"dark");
    q("themeToggle").textContent = light ? "â˜€ï¸/ğŸŒ™ ä¸»é¢˜" : "ğŸŒ™/â˜€ï¸ ä¸»é¢˜";
  }
  function loadTheme(){
    var t=localStorage.getItem("tarot_theme");
    if(t==="light"){ document.body.classList.add("light"); q("themeToggle").textContent="â˜€ï¸/ğŸŒ™ ä¸»é¢˜"; }
  }

  // è®°ä½ä¸Šæ¬¡åˆ†ç±»
  function initCategoryMemory(){
    var catSel = q("category");
    var lastCat = localStorage.getItem("tarot_last_cat");
    if (lastCat) catSel.value = lastCat;
    catSel.addEventListener("change", function(e){
      localStorage.setItem("tarot_last_cat", e.target.value);
    });
  }

  // actions
  function doDraw(){
    var mode=q("mode").value, note=q("note").value.trim(), category=q("category").value;
    var pack=draw(mode);
    lastPack={mode:mode, allowRev:true, cards:pack.cards, timestamp:ts(), note:note, category:category};
    renderResult(pack); pushHist(lastPack);
  }

  // bind
  window.addEventListener("DOMContentLoaded", function(){
    try{
      loadTheme(); loadBrand(); initCategoryMemory();

      q("brandPick").addEventListener("change", function(e){ applyBrandClass(e.target.value); });
      q("themeToggle").addEventListener("click", toggleTheme);

      q("draw").addEventListener("click", doDraw);
      q("redraw").addEventListener("click", doDraw);
      q("reset").addEventListener("click", function(){ q("cards").innerHTML=""; });

      q("toggleExplain").addEventListener("click", function(){ 
        SHOW_EXPLAIN=!SHOW_EXPLAIN; 
        this.textContent=SHOW_EXPLAIN?"éšè—è§£è¯»":"æŸ¥çœ‹è§£è¯»ï¼ˆä¸­æ€§ï¼‰"; 
        renderResult({mode:q("mode").value, cards:lastPack?lastPack.cards:[]}); 
      });
      q("toggleKW").addEventListener("click", function(){ 
        SHOW_KW=!SHOW_KW; 
        this.textContent=SHOW_KW?"éšè—å…³é”®è¯":"æ˜¾ç¤ºå…³é”®è¯"; 
        renderResult({mode:q("mode").value, cards:lastPack?lastPack.cards:[]}); 
      });

      q("copyMd").addEventListener("click", function(){ 
        if(!lastPack) return alert("å°šæ— ç»“æœã€‚"); 
        var md=toMD(lastPack); 
        navigator.clipboard.writeText(md).then(function(){alert("å·²å¤åˆ¶ Markdown")}).catch(function(){alert("å¤åˆ¶å¤±è´¥")}); 
      });
      q("exportReport").addEventListener("click", function(){
        if(!lastPack) return alert("å°šæ— ç»“æœã€‚");
        var name = "Tarot_"+ (lastPack.category||"æœªåˆ†ç±»") +"_"+ lastPack.timestamp.replace(/[: ]/g,"-") + ".md";
        download(name, toMD(lastPack));
      });
      q("exportCSV").addEventListener("click", function(){
        var list=applyFilter(loadHist()); if(!list.length) return alert("æš‚æ— å¯å¯¼å‡ºçš„å†å²ã€‚");
        var head=["timestamp","mode","category","allowReversed","cards","note"];
        var rows=list.map(function(r){
          var tags=positionTags(r.mode);
          var cs=r.cards.map(function(c,i){return tags[i]+":"+c.cn+(c.reversed?"(é€†)":"");}).join(" / ");
          return [r.timestamp,r.mode,r.category,"Y",cs,r.note||""].map(function(v){return '\"'+String(v).replace(/\"/g,'\"\"')+'\"';}).join(",");
        });
        download("tarot_history.csv", head.join(",")+"\n"+rows.join("\n"), "text/csv;charset=utf-8");
      });
      q("exportJSON").addEventListener("click", function(){
        var list=applyFilter(loadHist()); if(!list.length) return alert("æš‚æ— å¯å¯¼å‡ºçš„å†å²ã€‚");
        download("tarot_history.json", JSON.stringify(list,null,2), "application/json");
      });

      q("prevPage").addEventListener("click", function(){ CUR=Math.max(1, CUR-1); renderHistory(); });
      q("nextPage").addEventListener("click", function(){ CUR=CUR+1; renderHistory(); });
      q("filterKw").addEventListener("input", function(){ CUR=1; renderHistory(); });
      q("filterCat").addEventListener("change", function(){ CUR=1; renderHistory(); });

      // ä¿®å¤ï¼šæ¸…ç©ºå†å²æŒ‰é’®ç»‘å®š
      q("clearHistory").addEventListener("click", clearAllHistory);

      renderHistory();
    }catch(err){
      alert("åˆå§‹åŒ–é”™è¯¯: "+err.message);
      console.error(err);
    }
  });
})();
</script>
</body>
</html>

