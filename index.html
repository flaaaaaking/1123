!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tarot Â· çº¯æ–‡å­—æŠ½ç‰Œ</title>
  <style>
    :root {
      /* Dark (é»˜è®¤) */
      --bg: #0c0f13; --panel:#151922; --text:#e8ecf2; --muted:#9aa3b2; --brand:#6aa2ff; --line:#242a34;
      --input-bg:#1b2029; --input-border:#2a3140; --placeholder:#7b8494;
      --radius: 16px; --pad: 16px; --gap: 12px; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    @media (prefers-color-scheme: light){
      :root { --bg:#f7f8fa; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --brand:#4a6cf7; --line:#e5e7eb; --input-bg:#f1f3f5; --input-border:#d1d5db; --placeholder:#9ca3af; }
    }
    body.light { --bg:#f7f8fa; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --brand:#4a6cf7; --line:#e5e7eb; --input-bg:#f1f3f5; --input-border:#d1d5db; --placeholder:#9ca3af; }

    * { box-sizing: border-box; }
    body { margin:0; background: var(--bg); color: var(--text); font: 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .wrap { max-width: 980px; margin: 40px auto; padding: 0 16px; }
    .h1 { font-size: 24px; font-weight: 700; letter-spacing: .3px; display:flex; align-items:center; gap:10px; }
    .muted { color: var(--muted); }
    .card { background: var(--panel); border:1px solid var(--line); border-radius: var(--radius); padding: calc(var(--pad) + 4px); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
    label { display:block; font-weight:600; margin-bottom: 6px; }

    input[type="text"], select, textarea {
      width: 100%; background: var(--input-bg); color: var(--text);
      border:1px solid var(--input-border); border-radius: 12px; padding: 10px 12px; outline: none;
    }
    input::placeholder, textarea::placeholder { color: var(--placeholder); }

    .btns { display:flex; gap:10px; flex-wrap: wrap; }
    button { background: var(--input-bg); color: var(--text); border: 1px solid var(--input-border); padding: 10px 14px; border-radius: 12px; cursor: pointer; }
    button.primary { border-color: #2b3340; }
    button.brand { background: #162339; border-color: #2a416e; color: #d8e5ff; }
    button:active { transform: translateY(1px); }

    .list { display:flex; flex-direction: column; gap: 10px; }
    .item { border:1px dashed var(--input-border); border-radius: 12px; padding: 10px 12px; }
    .mono { font-family: var(--mono); }
    .kbd { font-family: var(--mono); background: var(--input-bg); border:1px solid var(--input-border); padding:0 6px; border-radius:6px; }
    .hr { height:1px; background: var(--line); margin: 14px 0; }
    .pill { display:inline-block; padding: 2px 8px; border:1px solid var(--input-border); border-radius:999px; font-size:12px; color: var(--muted); }
    .tag { display:inline-block; padding: 2px 8px; background: #111827; border:1px solid #22314d; border-radius:999px; font-size:12px; color:#c7d7ff; }
    .right { margin-left:auto; }
    @media (max-width: 800px){ .row, .row-3 { grid-template-columns: 1fr; } }

    .theme-btn { display:inline-flex; align-items:center; gap:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">
      <span>Tarot Â· çº¯æ–‡å­—æŠ½ç‰Œ</span>
      <span class="pill">å•æ–‡ä»¶ / æœ¬åœ°å¯å¼€</span>
      <span class="right"></span>
      <button id="themeToggle" class="theme-btn" type="button" title="åˆ‡æ¢æ˜æš—ä¸»é¢˜">ğŸŒ™/â˜€ï¸ ä¸»é¢˜</button>
    </div>
    <div class="muted" style="margin-top:6px">æ”¯æŒä¸é‡å¤æŠ½ç‰Œã€æ­£/é€†ä½ã€PPFã€<b>å…³ç³»ç›˜</b>ã€<b>äº”å¼ æ–¹æ¡ˆ</b>ä¸<b>åå¼ æ–¹æ¡ˆ</b>ã€‚å¯å¤åˆ¶ Markdownã€å¯¼å‡º CSV/JSONã€<b>ä¸€é”®å¯¼å‡ºå åœæŠ¥å‘Š</b>ã€‚</div>

    <div class="hr"></div>

    <section class="card" id="controls">
      <div class="row">
        <div>
          <label>æ¨¡å¼</label>
          <select id="mode">
            <option value="single">å•å¼ </option>
            <option value="ppf">ä¸‰å¼ ï¼ˆè¿‡å»-ç°åœ¨-æœªæ¥ï¼‰</option>
            <option value="relationship">å…³ç³»ç›˜ï¼ˆä½ /å¯¹æ–¹/æ ¸å¿ƒ/é˜»ç¢/å»ºè®®ï¼‰</option>
            <option value="five">äº”å¼ æ–¹æ¡ˆï¼ˆç°çŠ¶/é˜»ç¢/æ ¹æº/æ½œåŠ›/å»ºè®®ï¼‰</option>
            <option value="ten">åå¼ æ–¹æ¡ˆï¼ˆå‡¯å°”ç‰¹åå­—ï¼‰</option>
          </select>
        </div>
        <div>
          <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
          <input id="note" type="text" placeholder="ä¸ºè¿™æ¬¡å åœå†™ä¸€å¥è¯â€¦" />
        </div>
      </div>
      <div class="btns" style="margin-top:14px">
        <button class="brand" id="draw" type="button">æŠ½ ç‰Œ</button>
        <button class="primary" id="redraw" type="button">é‡æ–°æŠ½å–</button>
        <button id="reset" type="button">æ¸…ç©ºç»“æœ</button>
      </div>
    </section>

    <div style="height:14px"></div>

    <section class="card" id="result">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="font-weight:700">æŠ½ç‰Œç»“æœ</div>
        <div class="btns">
          <button id="copyMd" type="button">å¤åˆ¶ Markdown</button>
          <button id="exportReport" type="button">å¯¼å‡ºå åœæŠ¥å‘Šï¼ˆMDï¼‰</button>
          <button id="exportCSV" type="button">å¯¼å‡º CSV</button>
          <button id="exportJSON" type="button">å¯¼å‡º JSON</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="cards" class="list"></div>
      <div class="hr"></div>
      <details>
        <summary class="muted">ç®€è¦è§£é‡Šï¼ˆæŒ‰ä½ï¼‰</summary>
        <pre id="explain" class="mono" style="white-space:pre-wrap"></pre>
      </details>
    </section>

    <div style="height:14px"></div>

    <section class="card" id="history">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="font-weight:700">å†å²è®°å½•ï¼ˆæœ¬åœ°ï¼‰</div>
        <div class="btns">
          <button id="clearHistory" type="button">æ¸…ç©ºå†å²</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="historyList" class="list"></div>
    </section>

    <div style="height:18px"></div>
    <div class="muted">æç¤ºï¼šè¿™æ˜¯æœ¬åœ°é™æ€é¡µé¢ï¼Œç›´æ¥ç”¨ <span class="kbd">Chrome</span> æˆ– <span class="kbd">Safari</span> æ‰“å¼€å³å¯ã€‚è‹¥è¦æ”¾åˆ° Notionï¼Œå¯éƒ¨ç½²åˆ° Vercel/Netlify ååµŒå…¥ã€‚ä¸»é¢˜é»˜è®¤è·Ÿéšç³»ç»Ÿï¼Œå¯æ‰‹åŠ¨è¦†ç›–ã€‚</div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {

  const MAJOR = [
    {id:0,name:"The Fool",cn:"æ„šè€…",upr:["æ–°å¼€å§‹","è‡ªç”±","å†’é™©"],rev:["é²è½","çŠ¹è±«","æ–¹å‘ä¸æ˜"]},
    {id:1,name:"The Magician",cn:"é­”æœ¯å¸ˆ",upr:["æ„å¿—","èµ„æºæ•´åˆ","æ˜¾åŒ–"],rev:["æ“å¼„","åˆ†æ•£","æŠ€å·§å¤±çµ"]},
    {id:2,name:"The High Priestess",cn:"å¥³ç¥­å¸",upr:["ç›´è§‰","æ½œæ„è¯†","ä¿ç•™"],rev:["ç§˜å¯†","å‹æŠ‘","è‡ªæ¬º"]},
    {id:3,name:"The Empress",cn:"å¥³çš‡",upr:["ä¸°é¥¶","æ»‹å…»","å…³ç³»æˆé•¿"],rev:["è¿‡åº¦æººçˆ±","åœæ»","ä¾èµ–"]},
    {id:4,name:"The Emperor",cn:"çš‡å¸",upr:["ç»“æ„","æƒå¨","ç§©åº"],rev:["åƒµåŒ–","ç‹¬æ–­","æ§åˆ¶"]},
    {id:5,name:"The Hierophant",cn:"æ•™çš‡",upr:["ä¼ ç»Ÿ","å­¦ä¹ ","è§„èŒƒ"],rev:["æ•™æ¡","å›é€†","å½¢å¼ä¸»ä¹‰"]},
    {id:6,name:"The Lovers",cn:"æ‹äºº",upr:["é€‰æ‹©","å…³ç³»å¥‘åˆ","ä»·å€¼ä¸€è‡´"],rev:["æ‘‡æ‘†","è¯±æƒ‘","ä¸ä¸€è‡´"]},
    {id:7,name:"The Chariot",cn:"æˆ˜è½¦",upr:["æŒæ§","æ¨è¿›","èƒœåˆ©"],rev:["å¤±æ§","åˆ†è£‚","åŠ¨åŠ›ä¸è¶³"]},
    {id:8,name:"Strength",cn:"åŠ›é‡",upr:["è€å¿ƒ","æ¸©æŸ”çš„åŠ›é‡","è‡ªå¾‹"],rev:["æ€¥èº","å‹æŠ‘","è‡ªæˆ‘æ€€ç–‘"]},
    {id:9,name:"The Hermit",cn:"éšå£«",upr:["ç‹¬å¤„","å†…çœ","æŒ‡å¯¼"],rev:["é—­å¡","å­¤ç«‹","é€ƒé¿"]},
    {id:10,name:"Wheel of Fortune",cn:"å‘½è¿ä¹‹è½®",upr:["è½¬æœº","å‘¨æœŸ","æœºç¼˜"],rev:["é”™ä½","åœæ»","æ—¶æœºæœªè‡³"]},
    {id:11,name:"Justice",cn:"æ­£ä¹‰",upr:["å…¬å¹³","å› æœ","å†³æ–­"],rev:["åé¢‡","ä¸å¯¹ç­‰","æ‹–å»¶è£å†³"]},
    {id:12,name:"The Hanged Man",cn:"å€’åŠäºº",upr:["è§†è§’è½¬æ¢","æš‚åœ","ç‰ºç‰²"],rev:["å†…è€—","åƒµæŒ","ä¸æ„¿æ”¾ä¸‹"]},
    {id:13,name:"Death",cn:"æ­»ç¥",upr:["ç»ˆç»“ä¸é‡ç”Ÿ","æ–­èˆç¦»","æ›´æ–°"],rev:["æŠ—æ‹’æ”¹å˜","æ‹–å»¶","æ—§é—®é¢˜åå¤"]},
    {id:14,name:"Temperance",cn:"èŠ‚åˆ¶",upr:["è°ƒå’Œ","èŠ‚å¾‹","ä¸­é“"],rev:["å¤±è¡¡","è¿‡åº¦","èŠ‚å¥æ··ä¹±"]},
    {id:15,name:"The Devil",cn:"æ¶é­”",upr:["æ¬²æœ›","æŸç¼š","å¥‘çº¦"],rev:["è§‰é†’","è§£è„±","æ–­é“¾"]},
    {id:16,name:"The Tower",cn:"é«˜å¡”",upr:["çªå˜","å´©å¡Œ","çœŸç›¸æ˜¾éœ²"],rev:["å»¶è¿Ÿçˆ†å‘","ä½™éœ‡","ä¾¥å¹¸æœªå†³"]},
    {id:17,name:"The Star",cn:"æ˜Ÿæ˜Ÿ",upr:["å¸Œæœ›","ç–—æ„ˆ","è¿œæ™¯"],rev:["å¤±æœ›","æ¶ˆè€—","å…‰èŠ’å¾®å¼±"]},
    {id:18,name:"The Moon",cn:"æœˆäº®",upr:["è¿·é›¾","æƒ³è±¡","æ½œä¼"],rev:["æ˜æœ—","æ¸…é†’","ç–‘è™‘æ•£å»"]},
    {id:19,name:"The Sun",cn:"å¤ªé˜³",upr:["æ¸…æ™°","æˆåŠŸ","ç«¥çœŸ"],rev:["è¿‡æ›","è‡ªæ»¡","çŸ­æš‚å—é˜»"]},
    {id:20,name:"Judgement",cn:"å®¡åˆ¤",upr:["å¬å›","è§‰é†’","å¤ç›˜"],rev:["è¿Ÿç–‘","è‡ªè´£","é”™å¤±å¬å”¤"]},
    {id:21,name:"The World",cn:"ä¸–ç•Œ",upr:["å®Œæˆ","æ•´åˆ","æ—…ç¨‹ç»ˆç‚¹"],rev:["æœªç«Ÿä¹‹äº‹","æ”¶å°¾å›°éš¾","è¾¹ç•Œä¸æ¸…"]},
  ];

  const TAGS = {
    single: ['æ­¤åˆ»'],
    ppf: ['è¿‡å»','ç°åœ¨','æœªæ¥'],
    relationship: ['ä½ ','å¯¹æ–¹','å…³ç³»æ ¸å¿ƒ','é˜»ç¢','å»ºè®®'],
    five: ['ç°çŠ¶','é˜»ç¢','æ ¹æº','æ½œåŠ›','å»ºè®®'],
    ten: ['å½“ä¸‹','æŒ‘æˆ˜','æ½œæ„è¯†/æ ¹éƒ¨','æ˜¾æ„è¯†/è¡¨å±‚','è¿‡å»å½±å“','è¿‘æœŸæœªæ¥','æˆ‘æ–¹æ€åº¦','å¤–éƒ¨ç¯å¢ƒ','å¸Œæœ›/ææƒ§','ç»“æœ']
  };

  const $ = sel => document.querySelector(sel);
  const ts = () => new Date().toISOString().replace('T',' ').slice(0,19);
  function sampleNoRepeat(arr, n){ if(n>arr.length) throw new Error('æŠ½ç‰Œæ•°é‡è¶…è¿‡ç‰Œç»„å¤§å°'); const pool=arr.slice(),out=[]; for(let i=0;i<n;i++){ const idx=Math.floor(Math.random()*pool.length); out.push(pool[idx]); pool.splice(idx,1);} return out; }
  function positionTags(mode){ return TAGS[mode] || TAGS.single; }

  function draw(mode, allowRev){
    const n = positionTags(mode).length;
    const cards = sampleNoRepeat(MAJOR, n).map(c=>({ ...c, reversed: allowRev ? Math.random()<0.5 : false }));
    return { mode, allowRev, cards };
  }

  function buildExplain(rec){
    const tags = positionTags(rec.mode);
    return rec.cards.map((c,i)=>{
      const kws = (c.reversed ? c.rev : c.upr).slice(0,3).join('ã€') || 'ï¼ˆæ— ï¼‰';
      return `- ${tags[i]}ï½œ${c.cn}${c.reversed?'ï¼ˆé€†ä½ï¼‰':''} â†’ ${kws}`;
    }).join('\\n');
  }

  function buildSummarySentence(c){
    const pos = c.reversed ? 'é€†ä½' : 'æ­£ä½';
    const kws = (c.reversed ? c.rev : c.upr).slice(0,3);
    if(!kws.length) return `${c.cn}ï¼ˆ${pos}ï¼‰ï¼šæš‚æ— å…³é”®ä¿¡æ¯ã€‚`;
    return `${c.cn}ï¼ˆ${pos}ï¼‰ï¼šå€¾å‘äºâ€œ${kws.join('ã€')}â€ï¼Œæç¤ºä½ ä»¥æ›´ç¨³å¥ã€æ¸…é†’çš„æ–¹å¼å¤„ç†å½“å‰ä½ç½®çš„ä¸»é¢˜ã€‚`;
  }

  function buildReport(rec){
    const lines = [];
    lines.push(`# å åœæŠ¥å‘Š`);
    lines.push(`- æ—¶é—´ï¼š${rec.timestamp}`);
    lines.push(`- æ¨¡å¼ï¼š${rec.mode}`);
    lines.push(`- å…è®¸é€†ä½ï¼š${rec.allowRev ? 'æ˜¯' : 'å¦'}`);
    lines.push(`- å¤‡æ³¨ï¼š${rec.note || 'ï¼ˆæ— ï¼‰'}`);
    lines.push('');
    const tags = positionTags(rec.mode);
    lines.push('## æŠ½ç‰Œä¸è§£é‡Š');
    rec.cards.forEach((c,i)=>{
      const pos = c.reversed ? 'é€†ä½' : 'æ­£ä½';
      const kws = (c.reversed ? c.rev : c.upr).slice(0,3).join('ã€') || 'ï¼ˆæ— ï¼‰';
      const sent = buildSummarySentence(c);
      lines.push(`- **${tags[i]}**ï½œ**${c.cn} (${c.name})ï½œ${pos}**`);
      lines.push(`  - å…³é”®è¯ï¼š${kws}`);
      lines.push(`  - ç®€çŸ­è§£è¯»ï¼š${sent}`);
    });
    if(rec.mode==='relationship'){
      lines.push('');
      lines.push('## å…³ç³»ç›˜Â·å»ºè®®ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰');
      lines.push('- å…ˆè¯†åˆ«â€œé˜»ç¢â€ç‰Œæ‰€æŒ‡å‘çš„ç°å®é—®é¢˜ï¼Œå†æŒ‰â€œå»ºè®®â€é‡‡å–ä¸€ä¸ªå¯æ‰§è¡Œå°æ­¥éª¤ï¼ˆä¸€æ¬¡æ²Ÿé€š/è¾¹ç•Œç¡®è®¤/è§„åˆ™çº¦å®šï¼‰ã€‚');
    }
    lines.push('');
    lines.push('---');
    lines.push('> æœ¬æŠ¥å‘Šç”±æœ¬åœ°é™æ€é¡µé¢è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ç²˜è´´åˆ° Notion/Obsidianã€‚');
    return lines.join('\\n');
  }

  const KEY = 'tarot_history_v4';
  function loadHistory(){ try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } }
  function saveHistory(list){ localStorage.setItem(KEY, JSON.stringify(list)); }
  function pushHistory(item){ const list = loadHistory(); list.unshift(item); saveHistory(list); renderHistory(); }
  function clearHistory(){ saveHistory([]); renderHistory(); }

  function renderResult(pack){
    const tags = positionTags(pack.mode);
    const wrap = $('#cards'); wrap.innerHTML = '';
    pack.cards.forEach((c,i)=>{
      const div = document.createElement('div');
      div.className = 'item';
      const pos = c.reversed ? 'é€†ä½' : 'æ­£ä½';
      const kws = (c.reversed ? c.rev : c.upr).slice(0,3).join('ã€');
      div.innerHTML = `<div><span class="tag">${tags[i]}</span> ã€${c.cn} (${c.name})ï½œ${pos}ã€‘ å…³é”®è¯ï¼š${kws || 'ï¼ˆæ— ï¼‰'}</div>`;
      wrap.appendChild(div);
    });
    document.getElementById('explain').textContent = buildExplain(pack);
  }

  function renderHistory(){
    const list = loadHistory();
    const box = document.getElementById('historyList'); box.innerHTML = '';
    if(!list.length){ box.innerHTML = '<div class="muted">æš‚æ— è®°å½•ã€‚</div>'; return; }
    list.forEach(rec=>{
      const div = document.createElement('div');
      div.className = 'item';
      const tags = positionTags(rec.mode);
      const lines = rec.cards.map((c,i)=>`${tags[i]}ï½œ${c.cn}${c.reversed?'(é€†)':''}`).join(' | ');
      div.innerHTML = `<div><span class="pill">${rec.timestamp}</span> <span class="pill">${rec.mode}</span> <span class="muted">${rec.note?('ï½œ'+escapeHtml(rec.note)):' '}</span></div><div class="mono" style="margin-top:6px">${lines}</div>`;
      box.appendChild(div);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, function(m){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

  function toMarkdown(rec){
    const tags = positionTags(rec.mode);
    const head = `### æŠ½ç‰Œç»“æœï¼ˆ${rec.timestamp}ï¼‰\n- æ¨¡å¼ï¼š${rec.mode}ï½œå…è®¸é€†ä½ï¼š${rec.allowRev?'æ˜¯':'å¦'}\n- å¤‡æ³¨ï¼š${rec.note||'ï¼ˆæ— ï¼‰'}`;
    const lines = rec.cards.map((c,i)=>`- ${tags[i]}ï½œ${c.cn}${c.reversed?'ï¼ˆé€†ä½ï¼‰':''}ï½œå…³é”®è¯ï¼š${(c.reversed?c.rev:c.upr).slice(0,3).join('ã€')}`);
    return head + "\n" + lines.join("\n");
  }

  function download(filename, text, mime='text/markdown;charset=utf-8'){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type: mime}));
    a.download = filename; a.click(); URL.revokeObjectURL(a.href);
  }

  function exportCSV(){
    const list = loadHistory(); if(!list.length) return alert('æš‚æ— å¯å¯¼å‡ºçš„å†å²ã€‚');
    const header = ['timestamp','mode','allowReversed','cards','note'];
    const rows = list.map(r=>{
      const tags = positionTags(r.mode);
      const cs = r.cards.map((c,i)=>`${tags[i]}:${c.cn}${c.reversed?'(é€†)':''}`).join(' / ');
      return [r.timestamp, r.mode, r.allowRev?'Y':'N', cs, (r.note||'')].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
    });
    download('tarot_history.csv', header.join(',')+'\n'+rows.join('\n'), 'text/csv;charset=utf-8');
  }

  function exportJSON(){
    const list = loadHistory(); if(!list.length) return alert('æš‚æ— å¯å¯¼å‡ºçš„å†å²ã€‚');
    download('tarot_history.json', JSON.stringify(list, null, 2), 'application/json');
  }

  function exportReport(){
    if(!lastPack) return alert('å°šæ— ç»“æœã€‚');
    const md = buildReport(lastPack);
    download(`Tarot_Report_${lastPack.timestamp.replace(/[: ]/g,'-')}.md`, md);
  }

  const THEME_KEY = 'tarot_theme';
  function applyStoredTheme(){
    const t = localStorage.getItem(THEME_KEY);
    if(t==='light') document.body.classList.add('light');
    if(t==='dark') document.body.classList.remove('light');
  }
  function toggleTheme(){
    const isLight = document.body.classList.toggle('light');
    localStorage.setItem(THEME_KEY, isLight ? 'light' : 'dark');
  }

  let lastPack = null;
  function doDraw(){
    const mode = document.getElementById('mode').value;
    const allowRev = true;
    const note = document.getElementById('note').value.trim();
    const pack = draw(mode, allowRev);
    lastPack = { ...pack, timestamp: ts(), note };
    renderResult(pack); pushHistory(lastPack);
  }

  applyStoredTheme();
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);
  document.getElementById('draw').addEventListener('click', doDraw);
  document.getElementById('redraw').addEventListener('click', doDraw);
  document.getElementById('reset').addEventListener('click', ()=>{ document.getElementById('cards').innerHTML=''; document.getElementById('explain').textContent=''; });
  document.getElementById('clearHistory').addEventListener('click', ()=>{ if(confirm('ç¡®è®¤æ¸…ç©ºæœ¬åœ°å†å²ï¼Ÿ')) clearHistory(); });
  document.getElementById('copyMd').addEventListener('click', ()=>{ if(!lastPack) return alert('å°šæ— ç»“æœã€‚'); const md = toMarkdown(lastPack); navigator.clipboard.writeText(md).then(()=>alert('å·²å¤åˆ¶ Markdown')).catch(()=>alert('å¤åˆ¶å¤±è´¥')); });
  document.getElementById('exportCSV').addEventListener('click', exportCSV);
  document.getElementById('exportJSON').addEventListener('click', exportJSON);
  document.getElementById('exportReport').addEventListener('click', exportReport);

  renderHistory();
});
</script>
</body>
</html>
