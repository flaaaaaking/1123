<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Story Tarot · R17x.2</title>
<style>
  :root{
    --bg:#0c0f13; --panel:#151922; --text:#e8ecf2; --muted:#a0a6b4; --line:#242a34;
    --input-bg:#1b2029; --input-border:#2a3140; --placeholder:#7b8494;
    --brand:#6aa2ff; --brand-ink:#0b1324;
    --shadow: 0 2px 8px rgba(0,0,0,.18);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f8fa; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
           --input-bg:#f1f3f5; --input-border:#d1d5db; --placeholder:#9ca3af;
           --brand:#4a6cf7; --brand-ink:#ffffff; --shadow:0 2px 10px rgba(0,0,0,.06);}
  }
  body.light{ --bg:#f7f8fa; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
              --input-bg:#f1f3f5; --input-border:#d1d5db; --placeholder:#9ca3af; --shadow:0 2px 10px rgba(0,0,0,.06);}
  body.brand-blue{ --brand:#6aa2ff; --brand-ink:#0b1324; }
  body.brand-purple{ --brand:#b993ff; --brand-ink:#120a1a; }
  body.brand-gold{ --brand:#f1c232; --brand-ink:#201a06; }

  /* 背景渐变（仅深色下更明显） */
  body:not(.light).brand-purple{ background:linear-gradient(180deg, #0f0b17 0%, #14121c 40%, #0c0f13 100%); }
  body:not(.light).brand-gold{ background:linear-gradient(180deg, #0f0d08 0%, #171207 40%, #0c0f13 100%); }

  *{box-sizing:border-box}
  html,body{max-width:100%;overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.8 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  .header{display:flex;align-items:center;gap:10px}
  .title{font-size:22px;font-weight:800}
  .muted{color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:var(--shadow)}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  @media(max-width:840px){.row-3{grid-template-columns:1fr}}
  label{display:block;font-weight:650;margin-bottom:6px}
  .hint{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;background:var(--input-bg);border:1px solid var(--input-border);color:var(--muted);font-size:12px;cursor:help;margin-left:6px}

  input[type="text"],select,textarea{width:100%;background:var(--input-bg);color:var(--text);
    border:1px solid var(--input-border);border-radius:12px;padding:10px 12px;outline:none}
  input::placeholder,textarea::placeholder{color:var(--placeholder)}
  textarea{min-height:68px;resize:vertical}

  .btns{display:flex;gap:10px;flex-wrap:wrap}
  button{background:var(--input-bg);color:var(--text);border:1px solid var(--input-border);
    padding:10px 14px;border-radius:12px;cursor:pointer;transition:filter .12s ease, box-shadow .12s ease, transform .02s}
  button:hover{ filter:brightness(1.05) drop-shadow(0 0 0 rgba(0,0,0,0)); box-shadow:0 0 0 2px color-mix(in srgb, var(--brand) 26%, transparent) inset }
  button:active{transform:translateY(1px)}
  .primary{border-color:#2b3340}
  .accent{background:var(--brand);border-color:var(--brand);color:var(--brand-ink)}
  .accent:hover{ box-shadow:0 0 0 3px color-mix(in srgb, var(--brand) 35%, transparent) inset }

  .hr{height:1px;background:var(--line);margin:14px 0}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{border:1px dashed var(--input-border);border-radius:12px;padding:10px 12px;animation:fade .35s ease}
  .item:hover{background:color-mix(in srgb, var(--input-bg) 92%, transparent)}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--brand);color:var(--brand-ink);font-size:12px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--input-border);border-radius:999px;font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--input-bg);border:1px solid var(--input-border);padding:0 6px;border-radius:6px}
  .right{margin-left:auto}
  .story{white-space:pre-wrap; line-height:1.85; animation:fade .4s ease}
  .banner{display:none;margin:10px 0;padding:10px 12px;border-radius:12px;border:1px dashed var(--input-border);color:var(--muted)}
  .banner.show{display:block;animation:fade .35s ease}
  .toast{position:fixed;top:14px;right:14px;background:var(--panel);color:var(--text);border:1px solid var(--input-border);border-radius:12px;padding:8px 12px;opacity:0;transition:opacity .35s ease;z-index:9999;box-shadow:var(--shadow)}
  .fade-in{animation:fade .35s ease}
  @keyframes fade{from{opacity:.001;transform:translateY(2px)} to{opacity:1;transform:translateY(0)}}

  /* 导出菜单 */
  .menu{position:relative;display:inline-block}
  .menu .menu-btn{min-width:120px}
  .menu .menu-pop{position:absolute;right:0;top:calc(100% + 6px);background:var(--panel);border:1px solid var(--line);border-radius:12px;min-width:210px;box-shadow:var(--shadow);display:none;padding:6px}
  .menu.show .menu-pop{display:block;animation:fade .2s ease}
  .menu .menu-pop button{width:100%;text-align:left}

  /* 分页禁用态 */
  .disabled{opacity:.45;pointer-events:none}

  /* Notion嵌入阅读宽度优化 */
  #storyBox{max-width:720px}
</style>
</head>
<body class="brand-blue">
<div class="wrap">
  <div class="header">
    <div class="title">Story Tarot</div>
    <span class="pill">R17x.2</span>
    <span class="right"></span>
    <select id="brandPick" title="主题主色" style="max-width:160px">
      <option value="blue">主题色：蓝（理性）</option>
      <option value="purple">主题色：紫（直觉）</option>
      <option value="gold">主题色：金（力量）</option>
    </select>
    <button id="themeToggle" type="button" title="切换明/暗">🌙/☀️ 主题</button>
  </div>
  <div class="muted" style="margin-top:6px">默认仅显示牌面与正/逆；点击“查看解读（中性）”再显示释义；关键词与故事模式独立开关。</div>

  <div class="hr"></div>

  <section class="card">
    <div class="row-3">
      <div>
        <label>模式
          <span class="hint" title="单张：此刻能量\n三张：过去/现在/未来\n关系盘：你/对方/核心/阻碍/建议\n六芒星/十字：更完整结构">?</span>
        </label>
        <select id="mode">
          <option value="single">单张</option>
          <option value="ppf">三张（过去-现在-未来）</option>
          <option value="relationship">关系盘（你/对方/核心/阻碍/建议）</option>
          <option value="five">五张（现状/阻碍/根源/潜力/建议）</option>
          <option value="six">六芒星（现状/阻碍/助力/行动/外界/结果）</option>
          <option value="seven">七张（主题/障碍/根源/过去/现在/未来/建议）</option>
          <option value="ten">十张（凯尔特十字）</option>
        </select>
      </div>
      <div>
        <label>占卜分类</label>
        <select id="category">
          <option>情感</option><option>事业</option><option>学业</option>
          <option>健康</option><option>财务</option><option>人际</option><option>其他</option>
        </select>
      </div>
      <div>
        <label>备注（可选）</label>
        <textarea id="note" placeholder="写下此刻的情境/问题或一句心情…"></textarea>
      </div>
    </div>
    <div class="btns" style="margin-top:14px">
      <button class="accent" id="draw" type="button">抽 牌</button>
      <button class="primary" id="redraw" type="button">重新抽取</button>
      <button id="reset" type="button">清空结果</button>
      <span id="drawBanner" class="banner">🃏 已抽出牌面，点击下方“查看解读（中性）”或“展开故事模式”。</span>
    </div>
  </section>

  <div style="height:14px"></div>

  <section class="card" id="result">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div style="font-weight:700">抽牌结果</div>
      <div class="btns">
        <button id="toggleExplain" type="button">查看解读（中性）</button>
        <button id="toggleKW" type="button">显示关键词</button>
        <select id="tonePick" title="故事语气" style="min-width:120px">
          <option value="calm">🧊 冷静</option>
          <option value="poetic">🎭 文艺</option>
          <option value="fiery">🔥 激情</option>
        </select>
        <button id="storyBtn" type="button">展开故事模式</button>
        <div class="menu" id="exportMenu">
          <button class="menu-btn" type="button">📤 导出 / 复制</button>
          <div class="menu-pop">
            <button id="copyStory" type="button">复制故事文本</button>
            <button id="copyMd" type="button">复制 Markdown</button>
            <button id="exportReport" type="button">导出报告（MD）</button>
            <button id="exportCSV" type="button">导出 CSV</button>
            <button id="exportJSON" type="button">导出 JSON</button>
          </div>
        </div>
      </div>
    </div>
    <div class="hr"></div>
    <div id="cards" class="list"></div>
    <div class="hr"></div>
    <div id="storyBox" class="story muted">（点击“展开故事模式”生成情境背景 / 剧情展开 / 收尾剧）</div>
  </section>

  <div style="height:14px"></div>

  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div style="font-weight:700">历史记录（分页 / 每页 5 条）</div>
      <div class="btns">
        <input id="filterKw" type="text" placeholder="按关键词/备注过滤…" style="min-width:220px">
        <select id="filterCat">
          <option value="">全部分类</option>
          <option>情感</option><option>事业</option><option>学业</option>
          <option>健康</option><option>财务</option><option>人际</option><option>其他</option>
        </select>
        <button id="clearHistory" type="button">清空历史</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="historyList" class="list"></div>
    <div class="btns" style="justify-content:center">
      <button id="prevPage" type="button">上一页</button>
      <span class="pill" id="pageInfo">1 / 1</span>
      <button id="nextPage" type="button">下一页</button>
    </div>
  </section>

  <div style="height:18px"></div>
  <div class="muted">提示：主色（蓝/紫/金）与明/暗主题可独立切换；若未生效请强刷 <span class="kbd">Ctrl/Cmd+Shift+R</span>。</div>
</div>

<script>
(function(){
  // ====== 数据层 ======
  var MAJOR=[
    {id:0,name:"The Fool",cn:"愚者",upr:["新开始","自由","冒险"],rev:["鲁莽","犹豫","方向不明"], tag:["action","emotion"]},
    {id:1,name:"The Magician",cn:"魔术师",upr:["意志","资源整合","显化"],rev:["操弄","分散","技巧失灵"], tag:["cognition","action"]},
    {id:2,name:"The High Priestess",cn:"女祭司",upr:["直觉","潜意识","保留"],rev:["秘密","压抑","自欺"], tag:["emotion","cognition"]},
    {id:3,name:"The Empress",cn:"女皇",upr:["丰饶","滋养","关系成长"],rev:["过度溺爱","停滞","依赖"], tag:["emotion"]},
    {id:4,name:"The Emperor",cn:"皇帝",upr:["结构","权威","秩序"],rev:["僵化","独断","控制"], tag:["cognition","closure"]},
    {id:5,name:"The Hierophant",cn:"教皇",upr:["传统","学习","规范"],rev:["教条","叛逆","形式主义"], tag:["cognition"]},
    {id:6,name:"The Lovers",cn:"恋人",upr:["选择","关系契合","价值一致"],rev:["摇摆","诱惑","不一致"], tag:["emotion"]},
    {id:7,name:"The Chariot",cn:"战车",upr:["掌控","推进","胜利"],rev:["失控","分裂","动力不足"], tag:["action"]},
    {id:8,name:"Strength",cn:"力量",upr:["耐心","温柔的力量","自律"],rev:["急躁","压抑","自我怀疑"], tag:["action","emotion"]},
    {id:9,name:"The Hermit",cn:"隐士",upr:["独处","内省","指导"],rev:["闭塞","孤立","逃避"], tag:["cognition"]},
    {id:10,name:"Wheel of Fortune",cn:"命运之轮",upr:["转机","周期","机缘"],rev:["错位","停滞","时机未至"], tag:["closure"]},
    {id:11,name:"Justice",cn:"正义",upr:["公平","因果","决断"],rev:["偏颇","不对等","拖延裁决"], tag:["cognition","closure"]},
    {id:12,name:"The Hanged Man",cn:"倒吊人",upr:["视角转换","暂停","牺牲"],rev:["内耗","僵持","不愿放下"], tag:["cognition","emotion"]},
    {id:13,name:"Death",cn:"死神",upr:["终结与重生","断舍离","更新"],rev:["抗拒改变","拖延","旧问题反复"], tag:["closure"]},
    {id:14,name:"Temperance",cn:"节制",upr:["调和","节律","中道"],rev:["失衡","过度","节奏混乱"], tag:["cognition"]},
    {id:15,name:"The Devil",cn:"恶魔",upr:["欲望","束缚","契约"],rev:["觉醒","解脱","断链"], tag:["emotion"]},
    {id:16,name:"The Tower",cn:"高塔",upr:["突变","崩塌","真相显露"],rev:["延迟爆发","余震","侥幸未决"], tag:["closure"]},
    {id:17,name:"The Star",cn:"星星",upr:["希望","疗愈","远景"],rev:["失望","消耗","光芒微弱"], tag:["emotion"]},
    {id:18,name:"The Moon",cn:"月亮",upr:["迷雾","想象","潜伏"],rev:["明朗","清醒","疑虑散去"], tag:["emotion","cognition"]},
    {id:19,name:"The Sun",cn:"太阳",upr:["清晰","成功","童真"],rev:["过曝","自满","短暂受阻"], tag:["action","closure"]},
    {id:20,name:"Judgement",cn:"审判",upr:["召回","觉醒","复盘"],rev:["迟疑","自责","错失召唤"], tag:["closure"]},
    {id:21,name:"The World",cn:"世界",upr:["完成","整合","旅程终点"],rev:["未竟之事","收尾困难","边界不清"], tag:["closure"]}
  ];
  var MEANING={ /* 中性释义（保持非导向） */
    0:{upr:"新的开端与探索的状态，重视直觉与体验；强调开放心态与未知感。",rev:"能量分散或准备不足的状态，对方向与边界的把握较弱。"},
    1:{upr:"意志与资源被调动以达成目标的阶段，重在可行。",rev:"工具或沟通的失灵，力量未聚拢，效果不显。"},
    2:{upr:"信息尚在潜伏期，适合观察、保留意见、等待线索出现。",rev:"隐秘与不确定增多，难以直接获取明确讯息。"},
    3:{upr:"滋养与生长的环境，强调关系/项目的培育与扩展。",rev:"投入与产出不均衡，或过度依赖带来的停滞。"},
    4:{upr:"结构、秩序与边界清晰，重视制度与规则。",rev:"结构僵硬或控制过强，弹性不足。"},
    5:{upr:"遵循既有规范/传统的时期，强调学习与传承。",rev:"形式感压过实质，或对规则产生抗拒。"},
    6:{upr:"价值对齐与连接课题被提出，面向选择。",rev:"摇摆或诱因增多，需要澄清立场与价值。"},
    7:{upr:"向目标集中并推进的阶段，测试协调与意志。",rev:"动能受阻或方向分裂，推进效率下降。"},
    8:{upr:"内在稳住外在，强调耐心、自律与温和的力量。",rev:"自我怀疑或压抑情绪，能量需要复位。"},
    9:{upr:"主动抽离以观察与思考，积累洞见。",rev:"闭塞或回避外界互动，信息来源变窄。"},
    10:{upr:"周期转折点，机会与变动并存。",rev:"时机暂不匹配或外在条件未就绪。"},
    11:{upr:"评估与平衡的阶段，关注因果与对等。",rev:"失衡或延迟定夺，标准模糊。"},
    12:{upr:"暂停以换视角的阶段，强调让渡与观察。",rev:"停滞感上升，难以放下既有立场。"},
    13:{upr:"阶段性收束与更新的交界，释放旧要素。",rev:"对改变有所抗拒，旧议题反复出现。"},
    14:{upr:"调配节律、寻找中道与稳定输出。",rev:"节奏失衡，过度或不足影响稳定性。"},
    15:{upr:"契约、欲望与束缚课题被看见。",rev:"从束缚中抽离的迹象，关注解脱过程。"},
    16:{upr:"结构被触发调整，真相浮出。",rev:"变化仍在累积，后续影响待观察。"},
    17:{upr:"修复期与远景意识增强，关注恢复与方向感。",rev:"能量偏低或期待减弱，需要补给。"},
    18:{upr:"模糊期，直觉与想象高活跃，信息需辨识。",rev:"雾散迹象，判断逐步回到清晰。"},
    19:{upr:"清晰度与显化度上升，结果可见。",rev:"光照过强或阶段性受阻，节奏需调。"},
    20:{upr:"回看与回应的节点，强调召回与整合。",rev:"犹豫或自责干扰回应，窗口变窄。"},
    21:{upr:"阶段收拢、要素整合，完成度提升。",rev:"收尾不完全或边界模糊，尚需整理。"}
  };
  var TAGS={
    single:["此刻"],
    ppf:["过去","现在","未来"],
    relationship:["你","对方","关系核心","阻碍","建议"],
    five:["现状","阻碍","根源","潜力","建议"],
    six:["现状","阻碍","助力","行动","外界","结果"],
    seven:["主题","障碍","根源","过去","现在","未来","建议"],
    ten:["当下","挑战","潜意识/根部","显意识/表层","过去影响","近期未来","我方态度","外部环境","希望/恐惧","结果"]
  };

  // ====== 工具函数 ======
  function q(id){return document.getElementById(id);}
  function ts(){return new Date().toISOString().replace("T"," ").slice(0,19);}
  function sampleNoRepeat(arr,n){ if(n>arr.length) throw new Error("数量超过牌组"); var pool=arr.slice(),out=[]; for(var i=0;i<n;i++){ var idx=Math.floor(Math.random()*pool.length); out.push(pool[idx]); pool.splice(idx,1);} return out; }
  function positionTags(mode){ return TAGS[mode]||TAGS.single; }
  function toast(msg){ var t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); requestAnimationFrame(()=>t.style.opacity=1); setTimeout(()=>{t.style.opacity=0; setTimeout(()=>t.remove(),350);},2000); }

  // ====== 状态 ======
  var SHOW_EXPLAIN=false, SHOW_KW=false, lastPack=null;

  // ====== 抽牌与渲染 ======
  function draw(mode){
    var n=positionTags(mode).length;
    var cards=sampleNoRepeat(MAJOR,n).map(function(c){ return {
      id:c.id,name:c.name,cn:c.cn,upr:c.upr,rev:c.rev,tag:c.tag,reversed:Math.random()<0.5
    };});
    return {mode:mode,allowRev:true,cards:cards};
  }

  function neutralLine(card){
    var pos=card.reversed?"rev":"upr";
    var m=MEANING[card.id] ? MEANING[card.id][pos] : "";
    return "→ 牌面释义：" + (m||"状态描述缺省");
  }
  function kwLine(card){
    var arr=card.reversed?card.rev:card.upr;
    var s=(arr||[]).slice(0,3).join("、");
    return s?("关键词：" + s):"";
  }
  function tagIcon(card){
    var t=(card.tag||[])[0]; if(t==="emotion") return "💭"; if(t==="action") return "⚙️"; if(t==="cognition") return "🧩"; if(t==="closure") return "🌙"; return "🔹";
  }

  function renderResult(pack){
    var tags=positionTags(pack.mode);
    var wrap=q("cards"); wrap.innerHTML="";
    for(var i=0;i<pack.cards.length;i++){
      var c=pack.cards[i];
      var pos=c.reversed?"逆位":"正位";
      var head='<div><span class="tag">'+tags[i]+'</span> 【'+tagIcon(c)+' '+c.cn+' ('+c.name+')｜'+pos+'】</div>';
      var body="";
      if(SHOW_EXPLAIN){ body+='<div style="margin-top:6px">'+neutralLine(c)+'</div>'; }
      if(SHOW_KW){ var k=kwLine(c); if(k){ body+='<div class="muted" style="margin-top:6px">'+k+'</div>'; } }
      var div=document.createElement("div"); div.className="item"; div.innerHTML=head+body; wrap.appendChild(div);
    }
  }

  // ====== 历史（分页/过滤） ======
  var HKEY="tarot_history_clean_v1", PAGE=5, CUR=1;
  function loadHist(){ try{return JSON.parse(localStorage.getItem(HKEY)||"[]");}catch(e){return [];} }
  function saveHist(list){ localStorage.setItem(HKEY, JSON.stringify(list)); }
  function pushHist(item){ var l=loadHist(); l.unshift(item); saveHist(l); CUR=1; renderHistory(); }
  function applyFilter(list){
    var kw=(q("filterKw").value||"").trim();
    var cat=(q("filterCat").value||"").trim();
    return list.filter(function(r){
      var okc=!cat||r.category===cat;
      var blob=[r.mode,r.category,r.note].concat((r.cards||[]).map(function(c){return c.cn;})).join(" ");
      var okk=!kw||blob.indexOf(kw)>=0;
      return okc && okk;
    });
  }
  function renderHistory(){
    var full=loadHist(), filtered=applyFilter(full), total=filtered.length;
    var pages=Math.max(1, Math.ceil(total/PAGE));
    CUR=Math.max(1, Math.min(CUR,pages));
    var start=(CUR-1)*PAGE, slice=filtered.slice(start,start+PAGE);

    var box=q("historyList"); box.innerHTML="";
    if(!slice.length){ box.innerHTML='<div class="muted" style="text-align:center;opacity:.8">暂无记录。</div>'; }
    for(var i=0;i<slice.length;i++){
      var rec=slice[i], tags=positionTags(rec.mode);
      var lines=rec.cards.map(function(c,idx){ return tags[idx]+"｜"+c.cn+(c.reversed?"(逆)":""); }).join(" | ");
      var html='<div><span class="pill">'+rec.timestamp+'</span> <span class="pill">'+rec.mode+
                '</span> <span class="pill">'+(rec.category||"")+
                '</span> <span class="muted">'+(rec.note?("｜🗒️ "+rec.note):" ")+'</span></div>'+
                '<div style="margin-top:6px">'+lines+'</div>';
      var d=document.createElement("div"); d.className="item"; d.innerHTML=html; box.appendChild(d);
    }
    q("pageInfo").textContent=(pages?CUR:0)+" / "+pages;
    q("prevPage").classList.toggle("disabled", CUR<=1);
    q("nextPage").classList.toggle("disabled", CUR>=pages);
  }

  // ====== 导出 ======
  function toMD(rec){
    var tags=positionTags(rec.mode);
    var head="### 抽牌结果（"+rec.timestamp+"）\n- 模式："+rec.mode+"｜分类："+rec.category+"\n- 备注："+(rec.note||"（无）");
    var lines=rec.cards.map(function(c,i){
      var core="- "+tags[i]+"｜"+c.cn+(c.reversed?"（逆位）":"");
      var neu="  "+neutralLine(c);
      var kw=SHOW_KW?("  - "+kwLine(c)):"";
      return core+"\n"+neu+(kw?("\n"+kw):"");
    });
    var story = q("storyBox").dataset.filled==="1" ? ("\n\n---\n"+q("storyBox").textContent) : "";
    return head+"\n"+lines.join("\n")+story;
  }
  function download(name,text,mime){
    var a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([text],{type:mime||"text/markdown;charset=utf-8"}));
    a.download=name; a.click(); URL.revokeObjectURL(a.href);
  }

  // ====== 主题与主色 ======
  function applyBrandClass(val){
    document.body.classList.remove("brand-blue","brand-purple","brand-gold");
    document.body.classList.add("brand-"+val);
    localStorage.setItem("tarot_brand",val);
  }
  function loadBrand(){
    var v=localStorage.getItem("tarot_brand")||"blue";
    q("brandPick").value=v; applyBrandClass(v);
  }
  function toggleTheme(){
    var light=document.body.classList.toggle("light");
    localStorage.setItem("tarot_theme", light?"light":"dark");
    q("themeToggle").textContent = light ? "☀️/🌙 主题" : "🌙/☀️ 主题";
  }
  function loadTheme(){
    var t=localStorage.getItem("tarot_theme");
    if(t==="light"){ document.body.classList.add("light"); q("themeToggle").textContent="☀️/🌙 主题"; }
  }

  // ====== 记住上次分类 ======
  function initCategoryMemory(){
    var catSel = q("category");
    var lastCat = localStorage.getItem("tarot_last_cat");
    if (lastCat) catSel.value = lastCat;
    catSel.addEventListener("change", function(e){
      localStorage.setItem("tarot_last_cat", e.target.value);
    });
  }

  // ====== 故事引擎（含语气） ======
  function trendOf(cards){
    var score={emotion:0, action:0, cognition:0, closure:0};
    cards.forEach(function(c){ (c.tag||[]).forEach(function(t){ score[t]=(score[t]||0)+1; }); });
    var order=Object.keys(score).sort(function(a,b){return score[b]-score[a]});
    return {score:score, order:order};
  }
  function roleName(mode, idx){ return (positionTags(mode)[idx]||("位置"+(idx+1))); }

  var BG={
    "情感":"你正在处理一段关系的阶段性课题：不是非黑即白，而是在找‘怎样靠近更舒服’的方式。",
    "事业":"你处在节奏调整期：目标与方法的关系正在被重新摆放，需要一点试错空间。",
    "学业":"你的投入与产出在寻找平衡：理解与记忆不是对立面，节律会决定效率。",
    "健康":"你在与身体协商：能量与压力的张力需要更温和的管理。",
    "财务":"你在审视资源与选择：安全感来自秩序，也来自弹性。",
    "人际":"你在处理边界与连接：保持善意，同时厘清责任与期待。",
    "其他":"你正面对一个需要被分步拆解的主题：先看清，再决定。"
  };

  // 语气映射
  function sensoryLine(card, tone){
    var pos = card.reversed ? "逆位" : "正位";
    var base = card.reversed ? "像被按下的暂停键，能量在回收与修正之间。" : "像呼吸逐步平稳，事物在可控范围内显影。";
    if(tone==="poetic") base = card.reversed ? "像潮水回撤之前的静默，情绪在暗处缓慢重排。" : "像雾后初晴的空气，细微之处在光里被看见。";
    if(tone==="fiery") base = card.reversed ? "能量被堵在弯道，得先松开刹车再谈加速。" : "抓住当下的窗口，趁势推进会更顺。";
    return card.cn+"（"+pos+"）："+base;
  }
  function directionLine(card, tone){
    var dom = (card.tag||[])[0]||"cognition";
    var mapCalm = {
      emotion:"这张牌把注意力放在‘感受如何被看见’上。",
      action:"这张牌把注意力放在‘节奏与推进’上。",
      cognition:"这张牌把注意力放在‘观察与判断’上。",
      closure:"这张牌把注意力放在‘阶段收束与更新’上。"
    };
    var mapPoetic = {
      emotion:"它邀请你倾听情绪的边缘音，那里常常是答案的入口。",
      action:"它提醒节律与力量要并行，像心跳一样有序。",
      cognition:"它让思考先于动作，像点灯之后再走路。",
      closure:"它提议与你的终点握手，然后把脚步交给新的方向。"
    };
    var mapFiery = {
      emotion:"请把真实说出来，关系会因此更清楚。",
      action:"把第一步拆小、今天就动手。",
      cognition:"先给出你的标准，很多犹豫会立刻消失。",
      closure:"把不合时宜的部分关掉，你会轻很多。"
    };
    var m = tone==="poetic" ? mapPoetic : tone==="fiery" ? mapFiery : mapCalm;
    return m[dom];
  }
  function endingBy(trend, cards, category, tone){
    var has = function(ids){ return cards.some(function(c){ return ids.indexOf(c.id)>=0; }); };
    var endType="温和收束";
    if(has([13,16,20,21])) endType="转化与收尾";
    else if(trend.order[0]==="action") endType="行动与推进";
    else if(trend.order[0]==="emotion") endType="情绪与理解";
    else if(trend.order[0]==="cognition") endType="判断与取舍";
    var tail={
      "温和收束":"命运只在此刻显影，其余由你决定；把注意力放在能被你温柔掌控的小步进上。",
      "转化与收尾":"不是结束推动改变，而是改变让一个阶段自然告一段落；给新秩序一点时间。",
      "行动与推进":"把可行的第一步从今天切开来，不求一次到位，只求节律可持续。",
      "情绪与理解":"当感受被好好述说，很多‘要不要’都会自己找到答案。",
      "判断与取舍":"当标准被明确，选择本身就不再沉重。"
    };
    var hintMap={
      "情感":"关系需要被看见，也需要被允许呼吸。",
      "事业":"进度之外，稳定的节律同样重要。",
      "学业":"把理解放在记忆前面，效率会更有机。",
      "健康":"对身体的善意，会以另一种形式回到生活里。",
      "财务":"边花边省是成熟的训练，而非矛盾。",
      "人际":"边界清晰，连接才不会紧绷。",
      "其他":"问题被拆小，它就有了被解决的路径。"
    };
    var suffix = tone==="fiery" ? "给自己一个明确的时间点，让行动有落地的声响。" :
                 tone==="poetic" ? "请在夜深时与自己对话，答案常在沉静处浮出。" : "";
    return "【收尾剧】\n"+tail[endType]+"\n— "+(hintMap[category]||hintMap["其他"])+(suffix?("\n"+suffix):"");
  }
  function buildStory(pack, category, tone){
    if(!pack||!pack.cards||!pack.cards.length) return "（暂无可生成的故事）";
    var t = trendOf(pack.cards);
    var bg = "📖 【叙事背景】\n"+(BG[category]||BG["其他"])+"\n（主导语义："+t.order[0]+"）";

    var lines = pack.cards.map(function(c, i){
      var pos = roleName(pack.mode,i);
      var neu = MEANING[c.id] ? (c.reversed?MEANING[c.id].rev:MEANING[c.id].upr) : "";
      var dir = directionLine(c, tone);
      var sen = sensoryLine(c, tone);
      return "🎴 "+pos+"｜"+tagIcon(c)+" "+c.cn+(c.reversed?"（逆位）":"")+"\n"+
             "  · 牌面描述："+neu+"\n"+
             "  · 关注点："+dir+"\n"+
             "  · 氛围感："+sen;
    }).join("\n\n");

    var end = "🌅 "+endingBy(t, pack.cards, category, tone);
    return bg+"\n\n🎬 【剧情展开】\n"+lines+"\n\n"+end+"\n\n（注：此叙事用于自我观察与梳理，不构成结果性预测。）";
  }

  // ====== 动作 ======
  function doDraw(){
    var mode=q("mode").value, note=q("note").value.trim(), category=q("category").value;
    var pack=draw(mode);
    lastPack={mode:mode, allowRev:true, cards:pack.cards, timestamp:ts(), note:note, category:category};
    renderResult(pack); pushHist(lastPack);
    var banner=q("drawBanner"); banner.classList.add("show"); setTimeout(()=>banner.classList.remove("show"), 3000);
    var box=q("storyBox"); box.textContent="（点击“展开故事模式”生成情境背景 / 剧情展开 / 收尾剧）"; box.classList.add('muted'); box.dataset.filled="0";
    window.scrollTo({top:document.querySelector('#result').offsetTop-12, behavior:'smooth'});
  }

  function clearAllHistory(){
    if (!confirm("确认清空所有历史记录吗？此操作不可恢复。")) return;
    localStorage.removeItem(HKEY);
    renderHistory();
    var box = q("historyList"); if (box) box.innerHTML = '<div class="muted" style="text-align:center;opacity:.8">🧹 历史记录已清空</div>';
    var info = q("pageInfo"); if (info) info.textContent = '0 / 1';
    toast("历史记录已清空");
  }

  // ====== 事件绑定 ======
  window.addEventListener("DOMContentLoaded", function(){
    try{
      // 主题/主色
      loadTheme(); loadBrand(); initCategoryMemory();
      q("brandPick").addEventListener("change", function(e){ applyBrandClass(e.target.value); });
      q("themeToggle").addEventListener("click", toggleTheme);

      // 抽牌/重抽/清空结果
      q("draw").addEventListener("click", doDraw);
      q("redraw").addEventListener("click", doDraw);
      q("reset").addEventListener("click", function(){ q("cards").innerHTML=""; q("storyBox").textContent="（已清空结果）"; q("storyBox").dataset.filled="0"; toast("已清空结果"); });

      // 解读/关键词切换
      q("toggleExplain").addEventListener("click", function(){
        SHOW_EXPLAIN=!SHOW_EXPLAIN;
        this.textContent=SHOW_EXPLAIN?"隐藏解读":"查看解读（中性）";
        renderResult({mode:q("mode").value, cards:lastPack?lastPack.cards:[]});
      });
      q("toggleKW").addEventListener("click", function(){
        SHOW_KW=!SHOW_KW;
        this.textContent=SHOW_KW?"隐藏关键词":"显示关键词";
        renderResult({mode:q("mode").value, cards:lastPack?lastPack.cards:[]});
      });

      // 故事模式 + 语气
      q("storyBtn").addEventListener("click", function(){
        if(!lastPack) return toast("尚无结果，先抽牌吧");
        var tone=q("tonePick").value, s = buildStory(lastPack, q("category").value, tone);
        var sb=q("storyBox"); sb.textContent = s; sb.dataset.filled="1"; sb.classList.remove("muted"); sb.classList.add("fade-in");
        window.scrollTo({top:sb.parentElement.offsetTop-8, behavior:'smooth'});
      });

      // 导出菜单开合
      var menu=q("exportMenu");
      menu.querySelector('.menu-btn').addEventListener('click', ()=> menu.classList.toggle('show'));
      document.addEventListener('click', (e)=>{ if(!menu.contains(e.target)) menu.classList.remove('show'); });

      // 复制/导出
      q("copyStory").addEventListener("click", function(){
        if(q("storyBox").dataset.filled!=="1") return toast("请先点击“展开故事模式”");
        navigator.clipboard.writeText(q("storyBox").textContent).then(()=>toast("故事已复制")).catch(()=>toast("复制失败"));
      });
      q("copyMd").addEventListener("click", function(){
        if(!lastPack) return toast("尚无结果");
        var md=toMD(lastPack);
        navigator.clipboard.writeText(md).then(()=>toast("Markdown 已复制")).catch(()=>toast("复制失败"));
      });
      q("exportReport").addEventListener("click", function(){
        if(!lastPack) return toast("尚无结果");
        var name = "Tarot_"+ (lastPack.category||"未分类") +"_"+ lastPack.timestamp.replace(/[: ]/g,"-") + ".md";
        download(name, toMD(lastPack)); toast("已导出 Markdown");
      });
      q("exportCSV").addEventListener("click", function(){
        var list=applyFilter(loadHist()); if(!list.length) return toast("暂无可导出的历史");
        var head=["timestamp","mode","category","allowReversed","cards","note"];
        var rows=list.map(function(r){
          var tags=positionTags(r.mode);
          var cs=r.cards.map(function(c,i){return tags[i]+":"+c.cn+(c.reversed?"(逆)":"");}).join(" / ");
          return [r.timestamp,r.mode,r.category,"Y",cs,r.note||""].map(function(v){return '"'+String(v).replace(/"/g,'""')+'"';}).join(",");
        });
        download("tarot_history.csv", head.join(",")+"\n"+rows.join("\n"), "text/csv;charset=utf-8"); toast("已导出 CSV");
      });
      q("exportJSON").addEventListener("click", function(){
        var list=applyFilter(loadHist()); if(!list.length) return toast("暂无可导出的历史");
        download("tarot_history.json", JSON.stringify(list,null,2), "application/json"); toast("已导出 JSON");
      });

      // 历史过滤/分页/清空
      q("prevPage").addEventListener("click", function(){ CUR=Math.max(1, CUR-1); renderHistory(); });
      q("nextPage").addEventListener("click", function(){ CUR=CUR+1; renderHistory(); });
      q("filterKw").addEventListener("input", function(){ CUR=1; renderHistory(); });
      q("filterCat").addEventListener("change", function(){ CUR=1; renderHistory(); });
      q("clearHistory").addEventListener("click", clearAllHistory);

      // 初始化
      renderHistory();
    }catch(err){
      alert("初始化错误: "+err.message);
      console.error(err);
    }
  });
})();
</script>
</body>
</html>

