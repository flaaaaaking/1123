<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Story Tarot Â· R17x.2</title>
<style>
  :root{
    --bg:#0c0f13; --panel:#151922; --text:#e8ecf2; --muted:#a0a6b4; --line:#242a34;
    --input-bg:#1b2029; --input-border:#2a3140; --placeholder:#7b8494;
    --brand:#6aa2ff; --brand-ink:#0b1324;
    --shadow: 0 2px 8px rgba(0,0,0,.18);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f8fa; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
           --input-bg:#f1f3f5; --input-border:#d1d5db; --placeholder:#9ca3af;
           --brand:#4a6cf7; --brand-ink:#ffffff; --shadow:0 2px 10px rgba(0,0,0,.06);}
  }
  body.light{ --bg:#f7f8fa; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
              --input-bg:#f1f3f5; --input-border:#d1d5db; --placeholder:#9ca3af; --shadow:0 2px 10px rgba(0,0,0,.06);}
  body.brand-blue{ --brand:#6aa2ff; --brand-ink:#0b1324; }
  body.brand-purple{ --brand:#b993ff; --brand-ink:#120a1a; }
  body.brand-gold{ --brand:#f1c232; --brand-ink:#201a06; }

  /* èƒŒæ™¯æ¸å˜ï¼ˆä»…æ·±è‰²ä¸‹æ›´æ˜æ˜¾ï¼‰ */
  body:not(.light).brand-purple{ background:linear-gradient(180deg, #0f0b17 0%, #14121c 40%, #0c0f13 100%); }
  body:not(.light).brand-gold{ background:linear-gradient(180deg, #0f0d08 0%, #171207 40%, #0c0f13 100%); }

  *{box-sizing:border-box}
  html,body{max-width:100%;overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.8 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  .header{display:flex;align-items:center;gap:10px}
  .title{font-size:22px;font-weight:800}
  .muted{color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:var(--shadow)}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  @media(max-width:840px){.row-3{grid-template-columns:1fr}}
  label{display:block;font-weight:650;margin-bottom:6px}
  .hint{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;background:var(--input-bg);border:1px solid var(--input-border);color:var(--muted);font-size:12px;cursor:help;margin-left:6px}

  input[type="text"],select,textarea{width:100%;background:var(--input-bg);color:var(--text);
    border:1px solid var(--input-border);border-radius:12px;padding:10px 12px;outline:none}
  input::placeholder,textarea::placeholder{color:var(--placeholder)}
  textarea{min-height:68px;resize:vertical}

  .btns{display:flex;gap:10px;flex-wrap:wrap}
  button{background:var(--input-bg);color:var(--text);border:1px solid var(--input-border);
    padding:10px 14px;border-radius:12px;cursor:pointer;transition:filter .12s ease, box-shadow .12s ease, transform .02s}
  button:hover{ filter:brightness(1.05) drop-shadow(0 0 0 rgba(0,0,0,0)); box-shadow:0 0 0 2px color-mix(in srgb, var(--brand) 26%, transparent) inset }
  button:active{transform:translateY(1px)}
  .primary{border-color:#2b3340}
  .accent{background:var(--brand);border-color:var(--brand);color:var(--brand-ink)}
  .accent:hover{ box-shadow:0 0 0 3px color-mix(in srgb, var(--brand) 35%, transparent) inset }

  .hr{height:1px;background:var(--line);margin:14px 0}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{border:1px dashed var(--input-border);border-radius:12px;padding:10px 12px;animation:fade .35s ease}
  .item:hover{background:color-mix(in srgb, var(--input-bg) 92%, transparent)}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--brand);color:var(--brand-ink);font-size:12px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--input-border);border-radius:999px;font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--input-bg);border:1px solid var(--input-border);padding:0 6px;border-radius:6px}
  .right{margin-left:auto}
  .story{white-space:pre-wrap; line-height:1.85; animation:fade .4s ease}
  .banner{display:none;margin:10px 0;padding:10px 12px;border-radius:12px;border:1px dashed var(--input-border);color:var(--muted)}
  .banner.show{display:block;animation:fade .35s ease}
  .toast{position:fixed;top:14px;right:14px;background:var(--panel);color:var(--text);border:1px solid var(--input-border);border-radius:12px;padding:8px 12px;opacity:0;transition:opacity .35s ease;z-index:9999;box-shadow:var(--shadow)}
  .fade-in{animation:fade .35s ease}
  @keyframes fade{from{opacity:.001;transform:translateY(2px)} to{opacity:1;transform:translateY(0)}}

  /* å¯¼å‡ºèœå• */
  .menu{position:relative;display:inline-block}
  .menu .menu-btn{min-width:120px}
  .menu .menu-pop{position:absolute;right:0;top:calc(100% + 6px);background:var(--panel);border:1px solid var(--line);border-radius:12px;min-width:210px;box-shadow:var(--shadow);display:none;padding:6px}
  .menu.show .menu-pop{display:block;animation:fade .2s ease}
  .menu .menu-pop button{width:100%;text-align:left}

  /* åˆ†é¡µç¦ç”¨æ€ */
  .disabled{opacity:.45;pointer-events:none}

  /* NotionåµŒå…¥é˜…è¯»å®½åº¦ä¼˜åŒ– */
  #storyBox{max-width:720px}
</style>
</head>
<body class="brand-blue">
<div class="wrap">
  <div class="header">
    <div class="title">Story Tarot</div>
    <span class="pill">R17x.2</span>
    <span class="right"></span>
    <select id="brandPick" title="ä¸»é¢˜ä¸»è‰²" style="max-width:160px">
      <option value="blue">ä¸»é¢˜è‰²ï¼šè“ï¼ˆç†æ€§ï¼‰</option>
      <option value="purple">ä¸»é¢˜è‰²ï¼šç´«ï¼ˆç›´è§‰ï¼‰</option>
      <option value="gold">ä¸»é¢˜è‰²ï¼šé‡‘ï¼ˆåŠ›é‡ï¼‰</option>
    </select>
    <button id="themeToggle" type="button" title="åˆ‡æ¢æ˜/æš—">ğŸŒ™/â˜€ï¸ ä¸»é¢˜</button>
  </div>
  <div class="muted" style="margin-top:6px">é»˜è®¤ä»…æ˜¾ç¤ºç‰Œé¢ä¸æ­£/é€†ï¼›ç‚¹å‡»â€œæŸ¥çœ‹è§£è¯»ï¼ˆä¸­æ€§ï¼‰â€å†æ˜¾ç¤ºé‡Šä¹‰ï¼›å…³é”®è¯ä¸æ•…äº‹æ¨¡å¼ç‹¬ç«‹å¼€å…³ã€‚</div>

  <div class="hr"></div>

  <section class="card">
    <div class="row-3">
      <div>
        <label>æ¨¡å¼
          <span class="hint" title="å•å¼ ï¼šæ­¤åˆ»èƒ½é‡\nä¸‰å¼ ï¼šè¿‡å»/ç°åœ¨/æœªæ¥\nå…³ç³»ç›˜ï¼šä½ /å¯¹æ–¹/æ ¸å¿ƒ/é˜»ç¢/å»ºè®®\nå…­èŠ’æ˜Ÿ/åå­—ï¼šæ›´å®Œæ•´ç»“æ„">?</span>
        </label>
        <select id="mode">
          <option value="single">å•å¼ </option>
          <option value="ppf">ä¸‰å¼ ï¼ˆè¿‡å»-ç°åœ¨-æœªæ¥ï¼‰</option>
          <option value="relationship">å…³ç³»ç›˜ï¼ˆä½ /å¯¹æ–¹/æ ¸å¿ƒ/é˜»ç¢/å»ºè®®ï¼‰</option>
          <option value="five">äº”å¼ ï¼ˆç°çŠ¶/é˜»ç¢/æ ¹æº/æ½œåŠ›/å»ºè®®ï¼‰</option>
          <option value="six">å…­èŠ’æ˜Ÿï¼ˆç°çŠ¶/é˜»ç¢/åŠ©åŠ›/è¡ŒåŠ¨/å¤–ç•Œ/ç»“æœï¼‰</option>
          <option value="seven">ä¸ƒå¼ ï¼ˆä¸»é¢˜/éšœç¢/æ ¹æº/è¿‡å»/ç°åœ¨/æœªæ¥/å»ºè®®ï¼‰</option>
          <option value="ten">åå¼ ï¼ˆå‡¯å°”ç‰¹åå­—ï¼‰</option>
        </select>
      </div>
      <div>
        <label>å åœåˆ†ç±»</label>
        <select id="category">
          <option>æƒ…æ„Ÿ</option><option>äº‹ä¸š</option><option>å­¦ä¸š</option>
          <option>å¥åº·</option><option>è´¢åŠ¡</option><option>äººé™…</option><option>å…¶ä»–</option>
        </select>
      </div>
      <div>
        <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
        <textarea id="note" placeholder="å†™ä¸‹æ­¤åˆ»çš„æƒ…å¢ƒ/é—®é¢˜æˆ–ä¸€å¥å¿ƒæƒ…â€¦"></textarea>
      </div>
    </div>
    <div class="btns" style="margin-top:14px">
      <button class="accent" id="draw" type="button">æŠ½ ç‰Œ</button>
      <button class="primary" id="redraw" type="button">é‡æ–°æŠ½å–</button>
      <button id="reset" type="button">æ¸…ç©ºç»“æœ</button>
      <span id="drawBanner" class="banner">ğŸƒ å·²æŠ½å‡ºç‰Œé¢ï¼Œç‚¹å‡»ä¸‹æ–¹â€œæŸ¥çœ‹è§£è¯»ï¼ˆä¸­æ€§ï¼‰â€æˆ–â€œå±•å¼€æ•…äº‹æ¨¡å¼â€ã€‚</span>
    </div>
  </section>

  <div style="height:14px"></div>

  <section class="card" id="result">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div style="font-weight:700">æŠ½ç‰Œç»“æœ</div>
      <div class="btns">
        <button id="toggleExplain" type="button">æŸ¥çœ‹è§£è¯»ï¼ˆä¸­æ€§ï¼‰</button>
        <button id="toggleKW" type="button">æ˜¾ç¤ºå…³é”®è¯</button>
        <select id="tonePick" title="æ•…äº‹è¯­æ°”" style="min-width:120px">
          <option value="calm">ğŸ§Š å†·é™</option>
          <option value="poetic">ğŸ­ æ–‡è‰º</option>
          <option value="fiery">ğŸ”¥ æ¿€æƒ…</option>
        </select>
        <button id="storyBtn" type="button">å±•å¼€æ•…äº‹æ¨¡å¼</button>
        <div class="menu" id="exportMenu">
          <button class="menu-btn" type="button">ğŸ“¤ å¯¼å‡º / å¤åˆ¶</button>
          <div class="menu-pop">
            <button id="copyStory" type="button">å¤åˆ¶æ•…äº‹æ–‡æœ¬</button>
            <button id="copyMd" type="button">å¤åˆ¶ Markdown</button>
            <button id="exportReport" type="button">å¯¼å‡ºæŠ¥å‘Šï¼ˆMDï¼‰</button>
            <button id="exportCSV" type="button">å¯¼å‡º CSV</button>
            <button id="exportJSON" type="button">å¯¼å‡º JSON</button>
          </div>
        </div>
      </div>
    </div>
    <div class="hr"></div>
    <div id="cards" class="list"></div>
    <div class="hr"></div>
    <div id="storyBox" class="story muted">ï¼ˆç‚¹å‡»â€œå±•å¼€æ•…äº‹æ¨¡å¼â€ç”Ÿæˆæƒ…å¢ƒèƒŒæ™¯ / å‰§æƒ…å±•å¼€ / æ”¶å°¾å‰§ï¼‰</div>
  </section>

  <div style="height:14px"></div>

  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div style="font-weight:700">å†å²è®°å½•ï¼ˆåˆ†é¡µ / æ¯é¡µ 5 æ¡ï¼‰</div>
      <div class="btns">
        <input id="filterKw" type="text" placeholder="æŒ‰å…³é”®è¯/å¤‡æ³¨è¿‡æ»¤â€¦" style="min-width:220px">
        <select id="filterCat">
          <option value="">å…¨éƒ¨åˆ†ç±»</option>
          <option>æƒ…æ„Ÿ</option><option>äº‹ä¸š</option><option>å­¦ä¸š</option>
          <option>å¥åº·</option><option>è´¢åŠ¡</option><option>äººé™…</option><option>å…¶ä»–</option>
        </select>
        <button id="clearHistory" type="button">æ¸…ç©ºå†å²</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="historyList" class="list"></div>
    <div class="btns" style="justify-content:center">
      <button id="prevPage" type="button">ä¸Šä¸€é¡µ</button>
      <span class="pill" id="pageInfo">1 / 1</span>
      <button id="nextPage" type="button">ä¸‹ä¸€é¡µ</button>
    </div>
  </section>

  <div style="height:18px"></div>
  <div class="muted">æç¤ºï¼šä¸»è‰²ï¼ˆè“/ç´«/é‡‘ï¼‰ä¸æ˜/æš—ä¸»é¢˜å¯ç‹¬ç«‹åˆ‡æ¢ï¼›è‹¥æœªç”Ÿæ•ˆè¯·å¼ºåˆ· <span class="kbd">Ctrl/Cmd+Shift+R</span>ã€‚</div>
</div>

<script>
(function(){
  // ====== æ•°æ®å±‚ ======
  var MAJOR=[
    {id:0,name:"The Fool",cn:"æ„šè€…",upr:["æ–°å¼€å§‹","è‡ªç”±","å†’é™©"],rev:["é²è½","çŠ¹è±«","æ–¹å‘ä¸æ˜"], tag:["action","emotion"]},
    {id:1,name:"The Magician",cn:"é­”æœ¯å¸ˆ",upr:["æ„å¿—","èµ„æºæ•´åˆ","æ˜¾åŒ–"],rev:["æ“å¼„","åˆ†æ•£","æŠ€å·§å¤±çµ"], tag:["cognition","action"]},
    {id:2,name:"The High Priestess",cn:"å¥³ç¥­å¸",upr:["ç›´è§‰","æ½œæ„è¯†","ä¿ç•™"],rev:["ç§˜å¯†","å‹æŠ‘","è‡ªæ¬º"], tag:["emotion","cognition"]},
    {id:3,name:"The Empress",cn:"å¥³çš‡",upr:["ä¸°é¥¶","æ»‹å…»","å…³ç³»æˆé•¿"],rev:["è¿‡åº¦æººçˆ±","åœæ»","ä¾èµ–"], tag:["emotion"]},
    {id:4,name:"The Emperor",cn:"çš‡å¸",upr:["ç»“æ„","æƒå¨","ç§©åº"],rev:["åƒµåŒ–","ç‹¬æ–­","æ§åˆ¶"], tag:["cognition","closure"]},
    {id:5,name:"The Hierophant",cn:"æ•™çš‡",upr:["ä¼ ç»Ÿ","å­¦ä¹ ","è§„èŒƒ"],rev:["æ•™æ¡","å›é€†","å½¢å¼ä¸»ä¹‰"], tag:["cognition"]},
    {id:6,name:"The Lovers",cn:"æ‹äºº",upr:["é€‰æ‹©","å…³ç³»å¥‘åˆ","ä»·å€¼ä¸€è‡´"],rev:["æ‘‡æ‘†","è¯±æƒ‘","ä¸ä¸€è‡´"], tag:["emotion"]},
    {id:7,name:"The Chariot",cn:"æˆ˜è½¦",upr:["æŒæ§","æ¨è¿›","èƒœåˆ©"],rev:["å¤±æ§","åˆ†è£‚","åŠ¨åŠ›ä¸è¶³"], tag:["action"]},
    {id:8,name:"Strength",cn:"åŠ›é‡",upr:["è€å¿ƒ","æ¸©æŸ”çš„åŠ›é‡","è‡ªå¾‹"],rev:["æ€¥èº","å‹æŠ‘","è‡ªæˆ‘æ€€ç–‘"], tag:["action","emotion"]},
    {id:9,name:"The Hermit",cn:"éšå£«",upr:["ç‹¬å¤„","å†…çœ","æŒ‡å¯¼"],rev:["é—­å¡","å­¤ç«‹","é€ƒé¿"], tag:["cognition"]},
    {id:10,name:"Wheel of Fortune",cn:"å‘½è¿ä¹‹è½®",upr:["è½¬æœº","å‘¨æœŸ","æœºç¼˜"],rev:["é”™ä½","åœæ»","æ—¶æœºæœªè‡³"], tag:["closure"]},
    {id:11,name:"Justice",cn:"æ­£ä¹‰",upr:["å…¬å¹³","å› æœ","å†³æ–­"],rev:["åé¢‡","ä¸å¯¹ç­‰","æ‹–å»¶è£å†³"], tag:["cognition","closure"]},
    {id:12,name:"The Hanged Man",cn:"å€’åŠäºº",upr:["è§†è§’è½¬æ¢","æš‚åœ","ç‰ºç‰²"],rev:["å†…è€—","åƒµæŒ","ä¸æ„¿æ”¾ä¸‹"], tag:["cognition","emotion"]},
    {id:13,name:"Death",cn:"æ­»ç¥",upr:["ç»ˆç»“ä¸é‡ç”Ÿ","æ–­èˆç¦»","æ›´æ–°"],rev:["æŠ—æ‹’æ”¹å˜","æ‹–å»¶","æ—§é—®é¢˜åå¤"], tag:["closure"]},
    {id:14,name:"Temperance",cn:"èŠ‚åˆ¶",upr:["è°ƒå’Œ","èŠ‚å¾‹","ä¸­é“"],rev:["å¤±è¡¡","è¿‡åº¦","èŠ‚å¥æ··ä¹±"], tag:["cognition"]},
    {id:15,name:"The Devil",cn:"æ¶é­”",upr:["æ¬²æœ›","æŸç¼š","å¥‘çº¦"],rev:["è§‰é†’","è§£è„±","æ–­é“¾"], tag:["emotion"]},
    {id:16,name:"The Tower",cn:"é«˜å¡”",upr:["çªå˜","å´©å¡Œ","çœŸç›¸æ˜¾éœ²"],rev:["å»¶è¿Ÿçˆ†å‘","ä½™éœ‡","ä¾¥å¹¸æœªå†³"], tag:["closure"]},
    {id:17,name:"The Star",cn:"æ˜Ÿæ˜Ÿ",upr:["å¸Œæœ›","ç–—æ„ˆ","è¿œæ™¯"],rev:["å¤±æœ›","æ¶ˆè€—","å…‰èŠ’å¾®å¼±"], tag:["emotion"]},
    {id:18,name:"The Moon",cn:"æœˆäº®",upr:["è¿·é›¾","æƒ³è±¡","æ½œä¼"],rev:["æ˜æœ—","æ¸…é†’","ç–‘è™‘æ•£å»"], tag:["emotion","cognition"]},
    {id:19,name:"The Sun",cn:"å¤ªé˜³",upr:["æ¸…æ™°","æˆåŠŸ","ç«¥çœŸ"],rev:["è¿‡æ›","è‡ªæ»¡","çŸ­æš‚å—é˜»"], tag:["action","closure"]},
    {id:20,name:"Judgement",cn:"å®¡åˆ¤",upr:["å¬å›","è§‰é†’","å¤ç›˜"],rev:["è¿Ÿç–‘","è‡ªè´£","é”™å¤±å¬å”¤"], tag:["closure"]},
    {id:21,name:"The World",cn:"ä¸–ç•Œ",upr:["å®Œæˆ","æ•´åˆ","æ—…ç¨‹ç»ˆç‚¹"],rev:["æœªç«Ÿä¹‹äº‹","æ”¶å°¾å›°éš¾","è¾¹ç•Œä¸æ¸…"], tag:["closure"]}
  ];
  var MEANING={ /* ä¸­æ€§é‡Šä¹‰ï¼ˆä¿æŒéå¯¼å‘ï¼‰ */
    0:{upr:"æ–°çš„å¼€ç«¯ä¸æ¢ç´¢çš„çŠ¶æ€ï¼Œé‡è§†ç›´è§‰ä¸ä½“éªŒï¼›å¼ºè°ƒå¼€æ”¾å¿ƒæ€ä¸æœªçŸ¥æ„Ÿã€‚",rev:"èƒ½é‡åˆ†æ•£æˆ–å‡†å¤‡ä¸è¶³çš„çŠ¶æ€ï¼Œå¯¹æ–¹å‘ä¸è¾¹ç•Œçš„æŠŠæ¡è¾ƒå¼±ã€‚"},
    1:{upr:"æ„å¿—ä¸èµ„æºè¢«è°ƒåŠ¨ä»¥è¾¾æˆç›®æ ‡çš„é˜¶æ®µï¼Œé‡åœ¨å¯è¡Œã€‚",rev:"å·¥å…·æˆ–æ²Ÿé€šçš„å¤±çµï¼ŒåŠ›é‡æœªèšæ‹¢ï¼Œæ•ˆæœä¸æ˜¾ã€‚"},
    2:{upr:"ä¿¡æ¯å°šåœ¨æ½œä¼æœŸï¼Œé€‚åˆè§‚å¯Ÿã€ä¿ç•™æ„è§ã€ç­‰å¾…çº¿ç´¢å‡ºç°ã€‚",rev:"éšç§˜ä¸ä¸ç¡®å®šå¢å¤šï¼Œéš¾ä»¥ç›´æ¥è·å–æ˜ç¡®è®¯æ¯ã€‚"},
    3:{upr:"æ»‹å…»ä¸ç”Ÿé•¿çš„ç¯å¢ƒï¼Œå¼ºè°ƒå…³ç³»/é¡¹ç›®çš„åŸ¹è‚²ä¸æ‰©å±•ã€‚",rev:"æŠ•å…¥ä¸äº§å‡ºä¸å‡è¡¡ï¼Œæˆ–è¿‡åº¦ä¾èµ–å¸¦æ¥çš„åœæ»ã€‚"},
    4:{upr:"ç»“æ„ã€ç§©åºä¸è¾¹ç•Œæ¸…æ™°ï¼Œé‡è§†åˆ¶åº¦ä¸è§„åˆ™ã€‚",rev:"ç»“æ„åƒµç¡¬æˆ–æ§åˆ¶è¿‡å¼ºï¼Œå¼¹æ€§ä¸è¶³ã€‚"},
    5:{upr:"éµå¾ªæ—¢æœ‰è§„èŒƒ/ä¼ ç»Ÿçš„æ—¶æœŸï¼Œå¼ºè°ƒå­¦ä¹ ä¸ä¼ æ‰¿ã€‚",rev:"å½¢å¼æ„Ÿå‹è¿‡å®è´¨ï¼Œæˆ–å¯¹è§„åˆ™äº§ç”ŸæŠ—æ‹’ã€‚"},
    6:{upr:"ä»·å€¼å¯¹é½ä¸è¿æ¥è¯¾é¢˜è¢«æå‡ºï¼Œé¢å‘é€‰æ‹©ã€‚",rev:"æ‘‡æ‘†æˆ–è¯±å› å¢å¤šï¼Œéœ€è¦æ¾„æ¸…ç«‹åœºä¸ä»·å€¼ã€‚"},
    7:{upr:"å‘ç›®æ ‡é›†ä¸­å¹¶æ¨è¿›çš„é˜¶æ®µï¼Œæµ‹è¯•åè°ƒä¸æ„å¿—ã€‚",rev:"åŠ¨èƒ½å—é˜»æˆ–æ–¹å‘åˆ†è£‚ï¼Œæ¨è¿›æ•ˆç‡ä¸‹é™ã€‚"},
    8:{upr:"å†…åœ¨ç¨³ä½å¤–åœ¨ï¼Œå¼ºè°ƒè€å¿ƒã€è‡ªå¾‹ä¸æ¸©å’Œçš„åŠ›é‡ã€‚",rev:"è‡ªæˆ‘æ€€ç–‘æˆ–å‹æŠ‘æƒ…ç»ªï¼Œèƒ½é‡éœ€è¦å¤ä½ã€‚"},
    9:{upr:"ä¸»åŠ¨æŠ½ç¦»ä»¥è§‚å¯Ÿä¸æ€è€ƒï¼Œç§¯ç´¯æ´è§ã€‚",rev:"é—­å¡æˆ–å›é¿å¤–ç•Œäº’åŠ¨ï¼Œä¿¡æ¯æ¥æºå˜çª„ã€‚"},
    10:{upr:"å‘¨æœŸè½¬æŠ˜ç‚¹ï¼Œæœºä¼šä¸å˜åŠ¨å¹¶å­˜ã€‚",rev:"æ—¶æœºæš‚ä¸åŒ¹é…æˆ–å¤–åœ¨æ¡ä»¶æœªå°±ç»ªã€‚"},
    11:{upr:"è¯„ä¼°ä¸å¹³è¡¡çš„é˜¶æ®µï¼Œå…³æ³¨å› æœä¸å¯¹ç­‰ã€‚",rev:"å¤±è¡¡æˆ–å»¶è¿Ÿå®šå¤ºï¼Œæ ‡å‡†æ¨¡ç³Šã€‚"},
    12:{upr:"æš‚åœä»¥æ¢è§†è§’çš„é˜¶æ®µï¼Œå¼ºè°ƒè®©æ¸¡ä¸è§‚å¯Ÿã€‚",rev:"åœæ»æ„Ÿä¸Šå‡ï¼Œéš¾ä»¥æ”¾ä¸‹æ—¢æœ‰ç«‹åœºã€‚"},
    13:{upr:"é˜¶æ®µæ€§æ”¶æŸä¸æ›´æ–°çš„äº¤ç•Œï¼Œé‡Šæ”¾æ—§è¦ç´ ã€‚",rev:"å¯¹æ”¹å˜æœ‰æ‰€æŠ—æ‹’ï¼Œæ—§è®®é¢˜åå¤å‡ºç°ã€‚"},
    14:{upr:"è°ƒé…èŠ‚å¾‹ã€å¯»æ‰¾ä¸­é“ä¸ç¨³å®šè¾“å‡ºã€‚",rev:"èŠ‚å¥å¤±è¡¡ï¼Œè¿‡åº¦æˆ–ä¸è¶³å½±å“ç¨³å®šæ€§ã€‚"},
    15:{upr:"å¥‘çº¦ã€æ¬²æœ›ä¸æŸç¼šè¯¾é¢˜è¢«çœ‹è§ã€‚",rev:"ä»æŸç¼šä¸­æŠ½ç¦»çš„è¿¹è±¡ï¼Œå…³æ³¨è§£è„±è¿‡ç¨‹ã€‚"},
    16:{upr:"ç»“æ„è¢«è§¦å‘è°ƒæ•´ï¼ŒçœŸç›¸æµ®å‡ºã€‚",rev:"å˜åŒ–ä»åœ¨ç´¯ç§¯ï¼Œåç»­å½±å“å¾…è§‚å¯Ÿã€‚"},
    17:{upr:"ä¿®å¤æœŸä¸è¿œæ™¯æ„è¯†å¢å¼ºï¼Œå…³æ³¨æ¢å¤ä¸æ–¹å‘æ„Ÿã€‚",rev:"èƒ½é‡åä½æˆ–æœŸå¾…å‡å¼±ï¼Œéœ€è¦è¡¥ç»™ã€‚"},
    18:{upr:"æ¨¡ç³ŠæœŸï¼Œç›´è§‰ä¸æƒ³è±¡é«˜æ´»è·ƒï¼Œä¿¡æ¯éœ€è¾¨è¯†ã€‚",rev:"é›¾æ•£è¿¹è±¡ï¼Œåˆ¤æ–­é€æ­¥å›åˆ°æ¸…æ™°ã€‚"},
    19:{upr:"æ¸…æ™°åº¦ä¸æ˜¾åŒ–åº¦ä¸Šå‡ï¼Œç»“æœå¯è§ã€‚",rev:"å…‰ç…§è¿‡å¼ºæˆ–é˜¶æ®µæ€§å—é˜»ï¼ŒèŠ‚å¥éœ€è°ƒã€‚"},
    20:{upr:"å›çœ‹ä¸å›åº”çš„èŠ‚ç‚¹ï¼Œå¼ºè°ƒå¬å›ä¸æ•´åˆã€‚",rev:"çŠ¹è±«æˆ–è‡ªè´£å¹²æ‰°å›åº”ï¼Œçª—å£å˜çª„ã€‚"},
    21:{upr:"é˜¶æ®µæ”¶æ‹¢ã€è¦ç´ æ•´åˆï¼Œå®Œæˆåº¦æå‡ã€‚",rev:"æ”¶å°¾ä¸å®Œå…¨æˆ–è¾¹ç•Œæ¨¡ç³Šï¼Œå°šéœ€æ•´ç†ã€‚"}
  };
  var TAGS={
    single:["æ­¤åˆ»"],
    ppf:["è¿‡å»","ç°åœ¨","æœªæ¥"],
    relationship:["ä½ ","å¯¹æ–¹","å…³ç³»æ ¸å¿ƒ","é˜»ç¢","å»ºè®®"],
    five:["ç°çŠ¶","é˜»ç¢","æ ¹æº","æ½œåŠ›","å»ºè®®"],
    six:["ç°çŠ¶","é˜»ç¢","åŠ©åŠ›","è¡ŒåŠ¨","å¤–ç•Œ","ç»“æœ"],
    seven:["ä¸»é¢˜","éšœç¢","æ ¹æº","è¿‡å»","ç°åœ¨","æœªæ¥","å»ºè®®"],
    ten:["å½“ä¸‹","æŒ‘æˆ˜","æ½œæ„è¯†/æ ¹éƒ¨","æ˜¾æ„è¯†/è¡¨å±‚","è¿‡å»å½±å“","è¿‘æœŸæœªæ¥","æˆ‘æ–¹æ€åº¦","å¤–éƒ¨ç¯å¢ƒ","å¸Œæœ›/ææƒ§","ç»“æœ"]
  };

  // ====== å·¥å…·å‡½æ•° ======
  function q(id){return document.getElementById(id);}
  function ts(){return new Date().toISOString().replace("T"," ").slice(0,19);}
  function sampleNoRepeat(arr,n){ if(n>arr.length) throw new Error("æ•°é‡è¶…è¿‡ç‰Œç»„"); var pool=arr.slice(),out=[]; for(var i=0;i<n;i++){ var idx=Math.floor(Math.random()*pool.length); out.push(pool[idx]); pool.splice(idx,1);} return out; }
  function positionTags(mode){ return TAGS[mode]||TAGS.single; }
  function toast(msg){ var t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); requestAnimationFrame(()=>t.style.opacity=1); setTimeout(()=>{t.style.opacity=0; setTimeout(()=>t.remove(),350);},2000); }

  // ====== çŠ¶æ€ ======
  var SHOW_EXPLAIN=false, SHOW_KW=false, lastPack=null;

  // ====== æŠ½ç‰Œä¸æ¸²æŸ“ ======
  function draw(mode){
    var n=positionTags(mode).length;
    var cards=sampleNoRepeat(MAJOR,n).map(function(c){ return {
      id:c.id,name:c.name,cn:c.cn,upr:c.upr,rev:c.rev,tag:c.tag,reversed:Math.random()<0.5
    };});
    return {mode:mode,allowRev:true,cards:cards};
  }

  function neutralLine(card){
    var pos=card.reversed?"rev":"upr";
    var m=MEANING[card.id] ? MEANING[card.id][pos] : "";
    return "â†’ ç‰Œé¢é‡Šä¹‰ï¼š" + (m||"çŠ¶æ€æè¿°ç¼ºçœ");
  }
  function kwLine(card){
    var arr=card.reversed?card.rev:card.upr;
    var s=(arr||[]).slice(0,3).join("ã€");
    return s?("å…³é”®è¯ï¼š" + s):"";
  }
  function tagIcon(card){
    var t=(card.tag||[])[0]; if(t==="emotion") return "ğŸ’­"; if(t==="action") return "âš™ï¸"; if(t==="cognition") return "ğŸ§©"; if(t==="closure") return "ğŸŒ™"; return "ğŸ”¹";
  }

  function renderResult(pack){
    var tags=positionTags(pack.mode);
    var wrap=q("cards"); wrap.innerHTML="";
    for(var i=0;i<pack.cards.length;i++){
      var c=pack.cards[i];
      var pos=c.reversed?"é€†ä½":"æ­£ä½";
      var head='<div><span class="tag">'+tags[i]+'</span> ã€'+tagIcon(c)+' '+c.cn+' ('+c.name+')ï½œ'+pos+'ã€‘</div>';
      var body="";
      if(SHOW_EXPLAIN){ body+='<div style="margin-top:6px">'+neutralLine(c)+'</div>'; }
      if(SHOW_KW){ var k=kwLine(c); if(k){ body+='<div class="muted" style="margin-top:6px">'+k+'</div>'; } }
      var div=document.createElement("div"); div.className="item"; div.innerHTML=head+body; wrap.appendChild(div);
    }
  }

  // ====== å†å²ï¼ˆåˆ†é¡µ/è¿‡æ»¤ï¼‰ ======
  var HKEY="tarot_history_clean_v1", PAGE=5, CUR=1;
  function loadHist(){ try{return JSON.parse(localStorage.getItem(HKEY)||"[]");}catch(e){return [];} }
  function saveHist(list){ localStorage.setItem(HKEY, JSON.stringify(list)); }
  function pushHist(item){ var l=loadHist(); l.unshift(item); saveHist(l); CUR=1; renderHistory(); }
  function applyFilter(list){
    var kw=(q("filterKw").value||"").trim();
    var cat=(q("filterCat").value||"").trim();
    return list.filter(function(r){
      var okc=!cat||r.category===cat;
      var blob=[r.mode,r.category,r.note].concat((r.cards||[]).map(function(c){return c.cn;})).join(" ");
      var okk=!kw||blob.indexOf(kw)>=0;
      return okc && okk;
    });
  }
  function renderHistory(){
    var full=loadHist(), filtered=applyFilter(full), total=filtered.length;
    var pages=Math.max(1, Math.ceil(total/PAGE));
    CUR=Math.max(1, Math.min(CUR,pages));
    var start=(CUR-1)*PAGE, slice=filtered.slice(start,start+PAGE);

    var box=q("historyList"); box.innerHTML="";
    if(!slice.length){ box.innerHTML='<div class="muted" style="text-align:center;opacity:.8">æš‚æ— è®°å½•ã€‚</div>'; }
    for(var i=0;i<slice.length;i++){
      var rec=slice[i], tags=positionTags(rec.mode);
      var lines=rec.cards.map(function(c,idx){ return tags[idx]+"ï½œ"+c.cn+(c.reversed?"(é€†)":""); }).join(" | ");
      var html='<div><span class="pill">'+rec.timestamp+'</span> <span class="pill">'+rec.mode+
                '</span> <span class="pill">'+(rec.category||"")+
                '</span> <span class="muted">'+(rec.note?("ï½œğŸ—’ï¸ "+rec.note):" ")+'</span></div>'+
                '<div style="margin-top:6px">'+lines+'</div>';
      var d=document.createElement("div"); d.className="item"; d.innerHTML=html; box.appendChild(d);
    }
    q("pageInfo").textContent=(pages?CUR:0)+" / "+pages;
    q("prevPage").classList.toggle("disabled", CUR<=1);
    q("nextPage").classList.toggle("disabled", CUR>=pages);
  }

  // ====== å¯¼å‡º ======
  function toMD(rec){
    var tags=positionTags(rec.mode);
    var head="### æŠ½ç‰Œç»“æœï¼ˆ"+rec.timestamp+"ï¼‰\n- æ¨¡å¼ï¼š"+rec.mode+"ï½œåˆ†ç±»ï¼š"+rec.category+"\n- å¤‡æ³¨ï¼š"+(rec.note||"ï¼ˆæ— ï¼‰");
    var lines=rec.cards.map(function(c,i){
      var core="- "+tags[i]+"ï½œ"+c.cn+(c.reversed?"ï¼ˆé€†ä½ï¼‰":"");
      var neu="  "+neutralLine(c);
      var kw=SHOW_KW?("  - "+kwLine(c)):"";
      return core+"\n"+neu+(kw?("\n"+kw):"");
    });
    var story = q("storyBox").dataset.filled==="1" ? ("\n\n---\n"+q("storyBox").textContent) : "";
    return head+"\n"+lines.join("\n")+story;
  }
  function download(name,text,mime){
    var a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([text],{type:mime||"text/markdown;charset=utf-8"}));
    a.download=name; a.click(); URL.revokeObjectURL(a.href);
  }

  // ====== ä¸»é¢˜ä¸ä¸»è‰² ======
  function applyBrandClass(val){
    document.body.classList.remove("brand-blue","brand-purple","brand-gold");
    document.body.classList.add("brand-"+val);
    localStorage.setItem("tarot_brand",val);
  }
  function loadBrand(){
    var v=localStorage.getItem("tarot_brand")||"blue";
    q("brandPick").value=v; applyBrandClass(v);
  }
  function toggleTheme(){
    var light=document.body.classList.toggle("light");
    localStorage.setItem("tarot_theme", light?"light":"dark");
    q("themeToggle").textContent = light ? "â˜€ï¸/ğŸŒ™ ä¸»é¢˜" : "ğŸŒ™/â˜€ï¸ ä¸»é¢˜";
  }
  function loadTheme(){
    var t=localStorage.getItem("tarot_theme");
    if(t==="light"){ document.body.classList.add("light"); q("themeToggle").textContent="â˜€ï¸/ğŸŒ™ ä¸»é¢˜"; }
  }

  // ====== è®°ä½ä¸Šæ¬¡åˆ†ç±» ======
  function initCategoryMemory(){
    var catSel = q("category");
    var lastCat = localStorage.getItem("tarot_last_cat");
    if (lastCat) catSel.value = lastCat;
    catSel.addEventListener("change", function(e){
      localStorage.setItem("tarot_last_cat", e.target.value);
    });
  }

  // ====== æ•…äº‹å¼•æ“ï¼ˆå«è¯­æ°”ï¼‰ ======
  function trendOf(cards){
    var score={emotion:0, action:0, cognition:0, closure:0};
    cards.forEach(function(c){ (c.tag||[]).forEach(function(t){ score[t]=(score[t]||0)+1; }); });
    var order=Object.keys(score).sort(function(a,b){return score[b]-score[a]});
    return {score:score, order:order};
  }
  function roleName(mode, idx){ return (positionTags(mode)[idx]||("ä½ç½®"+(idx+1))); }

  var BG={
    "æƒ…æ„Ÿ":"ä½ æ­£åœ¨å¤„ç†ä¸€æ®µå…³ç³»çš„é˜¶æ®µæ€§è¯¾é¢˜ï¼šä¸æ˜¯éé»‘å³ç™½ï¼Œè€Œæ˜¯åœ¨æ‰¾â€˜æ€æ ·é è¿‘æ›´èˆ’æœâ€™çš„æ–¹å¼ã€‚",
    "äº‹ä¸š":"ä½ å¤„åœ¨èŠ‚å¥è°ƒæ•´æœŸï¼šç›®æ ‡ä¸æ–¹æ³•çš„å…³ç³»æ­£åœ¨è¢«é‡æ–°æ‘†æ”¾ï¼Œéœ€è¦ä¸€ç‚¹è¯•é”™ç©ºé—´ã€‚",
    "å­¦ä¸š":"ä½ çš„æŠ•å…¥ä¸äº§å‡ºåœ¨å¯»æ‰¾å¹³è¡¡ï¼šç†è§£ä¸è®°å¿†ä¸æ˜¯å¯¹ç«‹é¢ï¼ŒèŠ‚å¾‹ä¼šå†³å®šæ•ˆç‡ã€‚",
    "å¥åº·":"ä½ åœ¨ä¸èº«ä½“åå•†ï¼šèƒ½é‡ä¸å‹åŠ›çš„å¼ åŠ›éœ€è¦æ›´æ¸©å’Œçš„ç®¡ç†ã€‚",
    "è´¢åŠ¡":"ä½ åœ¨å®¡è§†èµ„æºä¸é€‰æ‹©ï¼šå®‰å…¨æ„Ÿæ¥è‡ªç§©åºï¼Œä¹Ÿæ¥è‡ªå¼¹æ€§ã€‚",
    "äººé™…":"ä½ åœ¨å¤„ç†è¾¹ç•Œä¸è¿æ¥ï¼šä¿æŒå–„æ„ï¼ŒåŒæ—¶å˜æ¸…è´£ä»»ä¸æœŸå¾…ã€‚",
    "å…¶ä»–":"ä½ æ­£é¢å¯¹ä¸€ä¸ªéœ€è¦è¢«åˆ†æ­¥æ‹†è§£çš„ä¸»é¢˜ï¼šå…ˆçœ‹æ¸…ï¼Œå†å†³å®šã€‚"
  };

  // è¯­æ°”æ˜ å°„
  function sensoryLine(card, tone){
    var pos = card.reversed ? "é€†ä½" : "æ­£ä½";
    var base = card.reversed ? "åƒè¢«æŒ‰ä¸‹çš„æš‚åœé”®ï¼Œèƒ½é‡åœ¨å›æ”¶ä¸ä¿®æ­£ä¹‹é—´ã€‚" : "åƒå‘¼å¸é€æ­¥å¹³ç¨³ï¼Œäº‹ç‰©åœ¨å¯æ§èŒƒå›´å†…æ˜¾å½±ã€‚";
    if(tone==="poetic") base = card.reversed ? "åƒæ½®æ°´å›æ’¤ä¹‹å‰çš„é™é»˜ï¼Œæƒ…ç»ªåœ¨æš—å¤„ç¼“æ…¢é‡æ’ã€‚" : "åƒé›¾ååˆæ™´çš„ç©ºæ°”ï¼Œç»†å¾®ä¹‹å¤„åœ¨å…‰é‡Œè¢«çœ‹è§ã€‚";
    if(tone==="fiery") base = card.reversed ? "èƒ½é‡è¢«å µåœ¨å¼¯é“ï¼Œå¾—å…ˆæ¾å¼€åˆ¹è½¦å†è°ˆåŠ é€Ÿã€‚" : "æŠ“ä½å½“ä¸‹çš„çª—å£ï¼Œè¶åŠ¿æ¨è¿›ä¼šæ›´é¡ºã€‚";
    return card.cn+"ï¼ˆ"+pos+"ï¼‰ï¼š"+base;
  }
  function directionLine(card, tone){
    var dom = (card.tag||[])[0]||"cognition";
    var mapCalm = {
      emotion:"è¿™å¼ ç‰ŒæŠŠæ³¨æ„åŠ›æ”¾åœ¨â€˜æ„Ÿå—å¦‚ä½•è¢«çœ‹è§â€™ä¸Šã€‚",
      action:"è¿™å¼ ç‰ŒæŠŠæ³¨æ„åŠ›æ”¾åœ¨â€˜èŠ‚å¥ä¸æ¨è¿›â€™ä¸Šã€‚",
      cognition:"è¿™å¼ ç‰ŒæŠŠæ³¨æ„åŠ›æ”¾åœ¨â€˜è§‚å¯Ÿä¸åˆ¤æ–­â€™ä¸Šã€‚",
      closure:"è¿™å¼ ç‰ŒæŠŠæ³¨æ„åŠ›æ”¾åœ¨â€˜é˜¶æ®µæ”¶æŸä¸æ›´æ–°â€™ä¸Šã€‚"
    };
    var mapPoetic = {
      emotion:"å®ƒé‚€è¯·ä½ å€¾å¬æƒ…ç»ªçš„è¾¹ç¼˜éŸ³ï¼Œé‚£é‡Œå¸¸å¸¸æ˜¯ç­”æ¡ˆçš„å…¥å£ã€‚",
      action:"å®ƒæé†’èŠ‚å¾‹ä¸åŠ›é‡è¦å¹¶è¡Œï¼Œåƒå¿ƒè·³ä¸€æ ·æœ‰åºã€‚",
      cognition:"å®ƒè®©æ€è€ƒå…ˆäºåŠ¨ä½œï¼Œåƒç‚¹ç¯ä¹‹åå†èµ°è·¯ã€‚",
      closure:"å®ƒæè®®ä¸ä½ çš„ç»ˆç‚¹æ¡æ‰‹ï¼Œç„¶åæŠŠè„šæ­¥äº¤ç»™æ–°çš„æ–¹å‘ã€‚"
    };
    var mapFiery = {
      emotion:"è¯·æŠŠçœŸå®è¯´å‡ºæ¥ï¼Œå…³ç³»ä¼šå› æ­¤æ›´æ¸…æ¥šã€‚",
      action:"æŠŠç¬¬ä¸€æ­¥æ‹†å°ã€ä»Šå¤©å°±åŠ¨æ‰‹ã€‚",
      cognition:"å…ˆç»™å‡ºä½ çš„æ ‡å‡†ï¼Œå¾ˆå¤šçŠ¹è±«ä¼šç«‹åˆ»æ¶ˆå¤±ã€‚",
      closure:"æŠŠä¸åˆæ—¶å®œçš„éƒ¨åˆ†å…³æ‰ï¼Œä½ ä¼šè½»å¾ˆå¤šã€‚"
    };
    var m = tone==="poetic" ? mapPoetic : tone==="fiery" ? mapFiery : mapCalm;
    return m[dom];
  }
  function endingBy(trend, cards, category, tone){
    var has = function(ids){ return cards.some(function(c){ return ids.indexOf(c.id)>=0; }); };
    var endType="æ¸©å’Œæ”¶æŸ";
    if(has([13,16,20,21])) endType="è½¬åŒ–ä¸æ”¶å°¾";
    else if(trend.order[0]==="action") endType="è¡ŒåŠ¨ä¸æ¨è¿›";
    else if(trend.order[0]==="emotion") endType="æƒ…ç»ªä¸ç†è§£";
    else if(trend.order[0]==="cognition") endType="åˆ¤æ–­ä¸å–èˆ";
    var tail={
      "æ¸©å’Œæ”¶æŸ":"å‘½è¿åªåœ¨æ­¤åˆ»æ˜¾å½±ï¼Œå…¶ä½™ç”±ä½ å†³å®šï¼›æŠŠæ³¨æ„åŠ›æ”¾åœ¨èƒ½è¢«ä½ æ¸©æŸ”æŒæ§çš„å°æ­¥è¿›ä¸Šã€‚",
      "è½¬åŒ–ä¸æ”¶å°¾":"ä¸æ˜¯ç»“æŸæ¨åŠ¨æ”¹å˜ï¼Œè€Œæ˜¯æ”¹å˜è®©ä¸€ä¸ªé˜¶æ®µè‡ªç„¶å‘Šä¸€æ®µè½ï¼›ç»™æ–°ç§©åºä¸€ç‚¹æ—¶é—´ã€‚",
      "è¡ŒåŠ¨ä¸æ¨è¿›":"æŠŠå¯è¡Œçš„ç¬¬ä¸€æ­¥ä»ä»Šå¤©åˆ‡å¼€æ¥ï¼Œä¸æ±‚ä¸€æ¬¡åˆ°ä½ï¼Œåªæ±‚èŠ‚å¾‹å¯æŒç»­ã€‚",
      "æƒ…ç»ªä¸ç†è§£":"å½“æ„Ÿå—è¢«å¥½å¥½è¿°è¯´ï¼Œå¾ˆå¤šâ€˜è¦ä¸è¦â€™éƒ½ä¼šè‡ªå·±æ‰¾åˆ°ç­”æ¡ˆã€‚",
      "åˆ¤æ–­ä¸å–èˆ":"å½“æ ‡å‡†è¢«æ˜ç¡®ï¼Œé€‰æ‹©æœ¬èº«å°±ä¸å†æ²‰é‡ã€‚"
    };
    var hintMap={
      "æƒ…æ„Ÿ":"å…³ç³»éœ€è¦è¢«çœ‹è§ï¼Œä¹Ÿéœ€è¦è¢«å…è®¸å‘¼å¸ã€‚",
      "äº‹ä¸š":"è¿›åº¦ä¹‹å¤–ï¼Œç¨³å®šçš„èŠ‚å¾‹åŒæ ·é‡è¦ã€‚",
      "å­¦ä¸š":"æŠŠç†è§£æ”¾åœ¨è®°å¿†å‰é¢ï¼Œæ•ˆç‡ä¼šæ›´æœ‰æœºã€‚",
      "å¥åº·":"å¯¹èº«ä½“çš„å–„æ„ï¼Œä¼šä»¥å¦ä¸€ç§å½¢å¼å›åˆ°ç”Ÿæ´»é‡Œã€‚",
      "è´¢åŠ¡":"è¾¹èŠ±è¾¹çœæ˜¯æˆç†Ÿçš„è®­ç»ƒï¼Œè€ŒéçŸ›ç›¾ã€‚",
      "äººé™…":"è¾¹ç•Œæ¸…æ™°ï¼Œè¿æ¥æ‰ä¸ä¼šç´§ç»·ã€‚",
      "å…¶ä»–":"é—®é¢˜è¢«æ‹†å°ï¼Œå®ƒå°±æœ‰äº†è¢«è§£å†³çš„è·¯å¾„ã€‚"
    };
    var suffix = tone==="fiery" ? "ç»™è‡ªå·±ä¸€ä¸ªæ˜ç¡®çš„æ—¶é—´ç‚¹ï¼Œè®©è¡ŒåŠ¨æœ‰è½åœ°çš„å£°å“ã€‚" :
                 tone==="poetic" ? "è¯·åœ¨å¤œæ·±æ—¶ä¸è‡ªå·±å¯¹è¯ï¼Œç­”æ¡ˆå¸¸åœ¨æ²‰é™å¤„æµ®å‡ºã€‚" : "";
    return "ã€æ”¶å°¾å‰§ã€‘\n"+tail[endType]+"\nâ€” "+(hintMap[category]||hintMap["å…¶ä»–"])+(suffix?("\n"+suffix):"");
  }
  function buildStory(pack, category, tone){
    if(!pack||!pack.cards||!pack.cards.length) return "ï¼ˆæš‚æ— å¯ç”Ÿæˆçš„æ•…äº‹ï¼‰";
    var t = trendOf(pack.cards);
    var bg = "ğŸ“– ã€å™äº‹èƒŒæ™¯ã€‘\n"+(BG[category]||BG["å…¶ä»–"])+"\nï¼ˆä¸»å¯¼è¯­ä¹‰ï¼š"+t.order[0]+"ï¼‰";

    var lines = pack.cards.map(function(c, i){
      var pos = roleName(pack.mode,i);
      var neu = MEANING[c.id] ? (c.reversed?MEANING[c.id].rev:MEANING[c.id].upr) : "";
      var dir = directionLine(c, tone);
      var sen = sensoryLine(c, tone);
      return "ğŸ´ "+pos+"ï½œ"+tagIcon(c)+" "+c.cn+(c.reversed?"ï¼ˆé€†ä½ï¼‰":"")+"\n"+
             "  Â· ç‰Œé¢æè¿°ï¼š"+neu+"\n"+
             "  Â· å…³æ³¨ç‚¹ï¼š"+dir+"\n"+
             "  Â· æ°›å›´æ„Ÿï¼š"+sen;
    }).join("\n\n");

    var end = "ğŸŒ… "+endingBy(t, pack.cards, category, tone);
    return bg+"\n\nğŸ¬ ã€å‰§æƒ…å±•å¼€ã€‘\n"+lines+"\n\n"+end+"\n\nï¼ˆæ³¨ï¼šæ­¤å™äº‹ç”¨äºè‡ªæˆ‘è§‚å¯Ÿä¸æ¢³ç†ï¼Œä¸æ„æˆç»“æœæ€§é¢„æµ‹ã€‚ï¼‰";
  }

  // ====== åŠ¨ä½œ ======
  function doDraw(){
    var mode=q("mode").value, note=q("note").value.trim(), category=q("category").value;
    var pack=draw(mode);
    lastPack={mode:mode, allowRev:true, cards:pack.cards, timestamp:ts(), note:note, category:category};
    renderResult(pack); pushHist(lastPack);
    var banner=q("drawBanner"); banner.classList.add("show"); setTimeout(()=>banner.classList.remove("show"), 3000);
    var box=q("storyBox"); box.textContent="ï¼ˆç‚¹å‡»â€œå±•å¼€æ•…äº‹æ¨¡å¼â€ç”Ÿæˆæƒ…å¢ƒèƒŒæ™¯ / å‰§æƒ…å±•å¼€ / æ”¶å°¾å‰§ï¼‰"; box.classList.add('muted'); box.dataset.filled="0";
    window.scrollTo({top:document.querySelector('#result').offsetTop-12, behavior:'smooth'});
  }

  function clearAllHistory(){
    if (!confirm("ç¡®è®¤æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;
    localStorage.removeItem(HKEY);
    renderHistory();
    var box = q("historyList"); if (box) box.innerHTML = '<div class="muted" style="text-align:center;opacity:.8">ğŸ§¹ å†å²è®°å½•å·²æ¸…ç©º</div>';
    var info = q("pageInfo"); if (info) info.textContent = '0 / 1';
    toast("å†å²è®°å½•å·²æ¸…ç©º");
  }

  // ====== äº‹ä»¶ç»‘å®š ======
  window.addEventListener("DOMContentLoaded", function(){
    try{
      // ä¸»é¢˜/ä¸»è‰²
      loadTheme(); loadBrand(); initCategoryMemory();
      q("brandPick").addEventListener("change", function(e){ applyBrandClass(e.target.value); });
      q("themeToggle").addEventListener("click", toggleTheme);

      // æŠ½ç‰Œ/é‡æŠ½/æ¸…ç©ºç»“æœ
      q("draw").addEventListener("click", doDraw);
      q("redraw").addEventListener("click", doDraw);
      q("reset").addEventListener("click", function(){ q("cards").innerHTML=""; q("storyBox").textContent="ï¼ˆå·²æ¸…ç©ºç»“æœï¼‰"; q("storyBox").dataset.filled="0"; toast("å·²æ¸…ç©ºç»“æœ"); });

      // è§£è¯»/å…³é”®è¯åˆ‡æ¢
      q("toggleExplain").addEventListener("click", function(){
        SHOW_EXPLAIN=!SHOW_EXPLAIN;
        this.textContent=SHOW_EXPLAIN?"éšè—è§£è¯»":"æŸ¥çœ‹è§£è¯»ï¼ˆä¸­æ€§ï¼‰";
        renderResult({mode:q("mode").value, cards:lastPack?lastPack.cards:[]});
      });
      q("toggleKW").addEventListener("click", function(){
        SHOW_KW=!SHOW_KW;
        this.textContent=SHOW_KW?"éšè—å…³é”®è¯":"æ˜¾ç¤ºå…³é”®è¯";
        renderResult({mode:q("mode").value, cards:lastPack?lastPack.cards:[]});
      });

      // æ•…äº‹æ¨¡å¼ + è¯­æ°”
      q("storyBtn").addEventListener("click", function(){
        if(!lastPack) return toast("å°šæ— ç»“æœï¼Œå…ˆæŠ½ç‰Œå§");
        var tone=q("tonePick").value, s = buildStory(lastPack, q("category").value, tone);
        var sb=q("storyBox"); sb.textContent = s; sb.dataset.filled="1"; sb.classList.remove("muted"); sb.classList.add("fade-in");
        window.scrollTo({top:sb.parentElement.offsetTop-8, behavior:'smooth'});
      });

      // å¯¼å‡ºèœå•å¼€åˆ
      var menu=q("exportMenu");
      menu.querySelector('.menu-btn').addEventListener('click', ()=> menu.classList.toggle('show'));
      document.addEventListener('click', (e)=>{ if(!menu.contains(e.target)) menu.classList.remove('show'); });

      // å¤åˆ¶/å¯¼å‡º
      q("copyStory").addEventListener("click", function(){
        if(q("storyBox").dataset.filled!=="1") return toast("è¯·å…ˆç‚¹å‡»â€œå±•å¼€æ•…äº‹æ¨¡å¼â€");
        navigator.clipboard.writeText(q("storyBox").textContent).then(()=>toast("æ•…äº‹å·²å¤åˆ¶")).catch(()=>toast("å¤åˆ¶å¤±è´¥"));
      });
      q("copyMd").addEventListener("click", function(){
        if(!lastPack) return toast("å°šæ— ç»“æœ");
        var md=toMD(lastPack);
        navigator.clipboard.writeText(md).then(()=>toast("Markdown å·²å¤åˆ¶")).catch(()=>toast("å¤åˆ¶å¤±è´¥"));
      });
      q("exportReport").addEventListener("click", function(){
        if(!lastPack) return toast("å°šæ— ç»“æœ");
        var name = "Tarot_"+ (lastPack.category||"æœªåˆ†ç±»") +"_"+ lastPack.timestamp.replace(/[: ]/g,"-") + ".md";
        download(name, toMD(lastPack)); toast("å·²å¯¼å‡º Markdown");
      });
      q("exportCSV").addEventListener("click", function(){
        var list=applyFilter(loadHist()); if(!list.length) return toast("æš‚æ— å¯å¯¼å‡ºçš„å†å²");
        var head=["timestamp","mode","category","allowReversed","cards","note"];
        var rows=list.map(function(r){
          var tags=positionTags(r.mode);
          var cs=r.cards.map(function(c,i){return tags[i]+":"+c.cn+(c.reversed?"(é€†)":"");}).join(" / ");
          return [r.timestamp,r.mode,r.category,"Y",cs,r.note||""].map(function(v){return '"'+String(v).replace(/"/g,'""')+'"';}).join(",");
        });
        download("tarot_history.csv", head.join(",")+"\n"+rows.join("\n"), "text/csv;charset=utf-8"); toast("å·²å¯¼å‡º CSV");
      });
      q("exportJSON").addEventListener("click", function(){
        var list=applyFilter(loadHist()); if(!list.length) return toast("æš‚æ— å¯å¯¼å‡ºçš„å†å²");
        download("tarot_history.json", JSON.stringify(list,null,2), "application/json"); toast("å·²å¯¼å‡º JSON");
      });

      // å†å²è¿‡æ»¤/åˆ†é¡µ/æ¸…ç©º
      q("prevPage").addEventListener("click", function(){ CUR=Math.max(1, CUR-1); renderHistory(); });
      q("nextPage").addEventListener("click", function(){ CUR=CUR+1; renderHistory(); });
      q("filterKw").addEventListener("input", function(){ CUR=1; renderHistory(); });
      q("filterCat").addEventListener("change", function(){ CUR=1; renderHistory(); });
      q("clearHistory").addEventListener("click", clearAllHistory);

      // åˆå§‹åŒ–
      renderHistory();
    }catch(err){
      alert("åˆå§‹åŒ–é”™è¯¯: "+err.message);
      console.error(err);
    }
  });
})();
</script>
</body>
</html>

